<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8">
  <title>Simulación · Generación de Dieta (DM2)</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='css/admin.css') }}">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    /* Complementos mínimos a tu admin.css (sin romper estilos existentes) */
    .container { max-width: 1100px; margin: 0 auto; padding: 16px; }
    .grid { display: grid; gap: 12px; }
    .grid-2 { grid-template-columns: repeat(2, minmax(0, 1fr)); }
    .grid-3 { grid-template-columns: repeat(3, minmax(0, 1fr)); }
    .card { border: 1px solid #e5e7eb; border-radius: 10px; padding: 14px; background: #fff; }
    .muted { color: #6b7280; font-size: 0.95rem; }
    .hidden { display: none; }
    .section-title { margin-top: 8px; margin-bottom: 4px; }
    details { border: 1px solid #e5e7eb; border-radius: 10px; padding: 8px 12px; background:#fff; }
    details + details { margin-top: 8px; }
    details summary { cursor: pointer; font-weight: 600; }
    table { width: 100%; border-collapse: collapse; }
    th, td { padding: 8px 10px; border-bottom: 1px solid #e5e7eb; text-align: right; }
    th:first-child, td:first-child { text-align: left; }
    .toolbar { display: flex; flex-wrap: wrap; gap: 8px; align-items: center; }
    .pill { display:inline-block; padding: 2px 8px; border:1px solid #e5e7eb; border-radius:999px; font-size:12px; color:#374151; }
    .kpi { font-weight: 600; }
    .small { font-size: 0.9rem; }
    .mb-0 { margin-bottom: 0; }
    .mb-2 { margin-bottom: 8px; }
    .mt-2 { margin-top: 8px; }
    .mt-3 { margin-top: 12px; }
    .mt-4 { margin-top: 16px; }
    .mr-8 { margin-right: 8px; }
    .w-100 { width: 100%; }
    .right { text-align: right; }
    .danger { color:#b91c1c; }
    .ok { color:#065f46; }

    @media print {
      .no-print { display: none !important; }
      body { background: #fff; }
      .container { padding: 0; }
      details { border: 0; padding: 0; }
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>Simulación · Generación de Dieta (DM2)</h1>

    <!-- Flash messages (misma convención que usas en login/activar) -->
    {% with messages = get_flashed_messages(with_categories=true) %}
      {% if messages %}
        <ul class="flash">
          {% for cat, msg in messages %}
            <li class="{{cat}}">{{ msg }}</li>
          {% endfor %}
        </ul>
      {% endif %}
    {% endwith %}

    <form id="sim-form" class="card no-print">
      <h2 class="section-title">Parámetros</h2>
      <div class="grid grid-3">
        <label>DNI
          <input type="text" name="dni" maxlength="8" required placeholder="8 dígitos">
        </label>
        <label>Fecha inicio
          <input type="date" name="fi" required>
        </label>
        <label>Fecha fin
          <input type="date" name="ff" required>
        </label>
      </div>

      <div class="grid grid-3 mt-2">
        <label>Kcal objetivo (día)
          <input type="number" name="kcal" min="1200" max="3000" step="50" value="1800" required>
        </label>
        <label>Actividad
          <select name="actividad">
            <option value="baja">Baja</option>
            <option value="moderada" selected>Moderada</option>
            <option value="alta">Alta</option>
          </select>
        </label>
        <label>Preferencias (múltiple)
          <div class="grid" style="grid-template-columns: 1fr 1fr;">
            <label><input type="checkbox" name="pref_sin_lacteos"> Sin lácteos</label>
            <label><input type="checkbox" name="pref_vegetariano"> Vegetariano</label>
            <label><input type="checkbox" name="pref_bajo_ig" checked> Bajo IG</label>
            <label><input type="checkbox" name="pref_alta_fibra" checked> Alta fibra</label>
          </div>
        </label>
      </div>

      <div class="mt-2">
        <label>Alergias / intolerancias (separadas por comas)
          <input type="text" name="alergias" placeholder="ej.: lactosa, pescado, nueces" class="w-100">
        </label>
        <p class="muted mb-0">Se evitarán ingredientes cuyo nombre contenga alguno de estos términos.</p>
      </div>

      <div class="form-actions mt-3 toolbar">
        <button class="btn" type="submit">Generar dieta (simulada)</button>
        <button class="btn secondary" type="button" id="btn-limpiar">Limpiar</button>
        <a class="btn secondary" href="{{ url_for('admin_planes') }}">Ir a Planes</a>
      </div>
    </form>

    <!-- Resultado -->
    <section id="resultado" class="hidden">
      <div class="toolbar no-print mt-4">
        <button class="btn" id="btn-regenerar">Regenerar</button>
        <button class="btn secondary" id="btn-guardar">Guardar plan (simulado)</button>
        <button class="btn secondary" id="btn-copiar">Copiar JSON</button>
        <button class="btn secondary" id="btn-pdf">Exportar PDF</button>
        <a class="btn secondary" href="#" id="btn-top">Volver arriba</a>
      </div>

      <div class="grid grid-3 mt-3">
        <div class="card">
          <div class="muted">Paciente (DNI)</div>
          <div id="kpi-dni" class="kpi">—</div>
        </div>
        <div class="card">
          <div class="muted">Rango de fechas</div>
          <div id="kpi-rango" class="kpi">—</div>
        </div>
        <div class="card">
          <div class="muted">Objetivo diario</div>
          <div id="kpi-obj" class="kpi">— kcal</div>
        </div>
      </div>

      <div class="card mt-3">
        <h2 class="section-title">Totales por día (simulación)</h2>
        <div class="muted small">Los totales se calculan sumando macronutrientes de cada comida (estimación por porción).</div>
        <div class="mt-2" id="tabla-totales"></div>
      </div>

      <div class="mt-3" id="acordeon">
        <!-- Aquí se inyectan los <details> por día -->
      </div>

      <div class="mt-4 muted">
        <span class="pill">Bajo IG</span>
        <span class="pill">Alta fibra</span>
        <span class="pill">Preferencias aplicadas</span>
      </div>
    </section>
  </div>

  <script>
    /***************
     * Dataset simple (por 100 g / unidad) — para SIMULACIÓN
     ***************/
    const FOODS = [
      {id:'avena', nombre:'Avena', unidad:'g', kcal:389, cho:66, pro:17, fat:7, fibra:10, tags:['cereal','bajo_ig','alta_fibra']},
      {id:'pan_integral', nombre:'Pan integral', unidad:'g', kcal:250, cho:43, pro:9, fat:4, fibra:6, tags:['cereal','bajo_ig','alta_fibra']},
      {id:'quinoa', nombre:'Quinua cocida', unidad:'g', kcal:120, cho:21, pro:4, fat:2, fibra:2.8, tags:['cereal','bajo_ig']},
      {id:'arroz_integral', nombre:'Arroz integral cocido', unidad:'g', kcal:111, cho:23, pro:2.6, fat:0.9, fibra:1.8, tags:['cereal','bajo_ig']},
      {id:'lentejas', nombre:'Lentejas cocidas', unidad:'g', kcal:116, cho:20, pro:9, fat:0.4, fibra:7.9, tags:['legumbre','bajo_ig','alta_fibra','vegetariano']},
      {id:'pollo', nombre:'Pechuga de pollo', unidad:'g', kcal:165, cho:0, pro:31, fat:3.6, fibra:0, tags:['proteina','animal']},
      {id:'pescado', nombre:'Pescado blanco', unidad:'g', kcal:120, cho:0, pro:20, fat:4, fibra:0, tags:['proteina','animal']},
      {id:'huevo', nombre:'Huevo', unidad:'ud', kcal:78, cho:0.6, pro:6.3, fat:5.3, fibra:0, gr_por_ud:50, tags:['proteina','ovolacto']},
      {id:'yogurt', nombre:'Yogurt descremado', unidad:'g', kcal:61, cho:7, pro:5, fat:0.3, fibra:0, tags:['lacteo']},
      {id:'manzana', nombre:'Manzana', unidad:'g', kcal:52, cho:14, pro:0.3, fat:0.2, fibra:2.4, tags:['fruta','bajo_ig','alta_fibra']},
      {id:'palta', nombre:'Palta', unidad:'g', kcal:160, cho:9, pro:2, fat:15, fibra:7, tags:['grasa','bajo_ig','alta_fibra']},
      {id:'aceite', nombre:'Aceite de oliva', unidad:'g', kcal:884, cho:0, pro:0, fat:100, fibra:0, tags:['grasa']},
      {id:'brocoli', nombre:'Brócoli', unidad:'g', kcal:34, cho:7, pro:2.8, fat:0.4, fibra:2.6, tags:['verdura','bajo_ig','alta_fibra']},
      {id:'camote', nombre:'Camote', unidad:'g', kcal:86, cho:20, pro:1.6, fat:0.1, fibra:3, tags:['tuberculo','bajo_ig']},
      {id:'frutos_secos', nombre:'Frutos secos mixtos', unidad:'g', kcal:600, cho:20, pro:20, fat:54, fibra:8, tags:['grasa','alta_fibra']},
    ];

    const MEALS = ['Desayuno','Media mañana','Almuerzo','Merienda','Cena'];
    const DIST = { 'Desayuno':0.25, 'Media mañana':0.10, 'Almuerzo':0.35, 'Merienda':0.10, 'Cena':0.20 };

    // Plantillas de menú por comida (listas de {id, qty, kind})
    const TEMPLATES = {
      'Desayuno': [
        [{id:'avena', g:40},{id:'yogurt', g:200},{id:'manzana', g:150}],
        [{id:'pan_integral', g:60},{id:'huevo', ud:1},{id:'palta', g:30}],
        [{id:'quinoa', g:150},{id:'manzana', g:150},{id:'frutos_secos', g:15}],
      ],
      'Media mañana': [
        [{id:'manzana', g:180},{id:'frutos_secos', g:15}],
        [{id:'yogurt', g:180},{id:'avena', g:20}],
      ],
      'Almuerzo': [
        [{id:'pollo', g:120},{id:'arroz_integral', g:150},{id:'brocoli', g:150},{id:'aceite', g:5}],
        [{id:'lentejas', g:220},{id:'quinoa', g:100},{id:'brocoli', g:150},{id:'aceite', g:5}],
        [{id:'pescado', g:120},{id:'camote', g:180},{id:'brocoli', g:150},{id:'aceite', g:5}],
      ],
      'Merienda': [
        [{id:'yogurt', g:150},{id:'manzana', g:120}],
        [{id:'pan_integral', g:40},{id:'palta', g:20}],
      ],
      'Cena': [
        [{id:'pollo', g:90},{id:'quinoa', g:80},{id:'brocoli', g:200},{id:'aceite', g:5}],
        [{id:'lentejas', g:200},{id:'brocoli', g:200},{id:'aceite', g:5}],
        [{id:'huevo', ud:2},{id:'pan_integral', g:40},{id:'brocoli', g:180}],
      ],
    };

    function toGrams(item) {
      const ref = FOODS.find(f=>f.id===item.id);
      if (!ref) return 0;
      if (item.g) return item.g;
      if (item.ud) return (ref.gr_por_ud || 50) * item.ud;
      return 0;
    }

    function macrosOf(item) {
      const ref = FOODS.find(f=>f.id===item.id);
      const g = toGrams(item);
      let factor = g/100.0;
      return {
        kcal: +(ref.kcal*factor).toFixed(1),
        cho: +(ref.cho*factor).toFixed(1),
        pro: +(ref.pro*factor).toFixed(1),
        fat: +(ref.fat*factor).toFixed(1),
        fibra: +(ref.fibra*factor).toFixed(1),
        label: ref.nombre + ' ' + (item.ud ? `${item.ud} ud` : `${g} g`)
      };
    }

    function sumMacros(list) {
      return list.reduce((acc, it)=>({
        kcal: +(acc.kcal + it.kcal).toFixed(1),
        cho: +(acc.cho + it.cho).toFixed(1),
        pro: +(acc.pro + it.pro).toFixed(1),
        fat: +(acc.fat + it.fat).toFixed(1),
        fibra: +(acc.fibra + it.fibra).toFixed(1),
      }), {kcal:0,cho:0,pro:0,fat:0,fibra:0});
    }

    function cumplePreferencias(item, prefs, alergias) {
      const ref = FOODS.find(f=>f.id===item.id);
      const name = ref?.nombre?.toLowerCase() || '';
      if (alergias.some(a => a && name.includes(a))) return false;
      if (prefs.sin_lacteos && ref.tags.includes('lacteo')) return false;
      if (prefs.vegetariano && ref.tags.includes('animal')) return false;
      // Si piden bajo IG/alta fibra, preferimos mantener, pero no invalidamos verduras/legumbres/cereales integrales
      return true;
    }

    function filtraTemplate(platillos, prefs, alergias) {
      const ok = platillos.every(p => cumplePreferencias(p, prefs, alergias));
      return ok;
    }

    function randomChoice(arr) {
      return arr[Math.floor(Math.random()*arr.length)];
    }

    function generarDia(kcalObjetivoDia, prefs, alergias) {
      const dia = {};
      for (const meal of MEALS) {
        const target = Math.round(kcalObjetivoDia * DIST[meal]);
        let opciones = TEMPLATES[meal].filter(t => filtraTemplate(t, prefs, alergias));
        if (opciones.length === 0) {
          // Fallback vegetariano sin lácteos si fuera necesario
          opciones = TEMPLATES[meal].filter(t => t.every(p => {
            const f = FOODS.find(x=>x.id===p.id);
            return f && !f.tags.includes('animal') && !f.tags.includes('lacteo');
          }));
          if (opciones.length === 0) opciones = TEMPLATES[meal]; // último recurso
        }
        let plantilla = randomChoice(opciones);

        // Ajuste simple de porciones hacia el objetivo (escala suave 0.85–1.15)
        const baseMacros = sumMacros(plantilla.map(macrosOf));
        let scale = 1.0;
        if (baseMacros.kcal > 0) {
          scale = Math.max(0.85, Math.min(1.15, target / baseMacros.kcal));
        }
        const ajustado = plantilla.map(p => {
          if (p.g) return {...p, g: Math.round(p.g * scale)};
          if (p.ud) return {...p, ud: Math.max(1, Math.round(p.ud * scale))};
          return p;
        });

        const items = ajustado.map(macrosOf);
        const tot = sumMacros(items);
        dia[meal] = { items, tot, target };
      }
      return dia;
    }

    function rangos(fechaIni, fechaFin) {
      const out = [];
      const d0 = new Date(fechaIni);
      const d1 = new Date(fechaFin);
      let cur = new Date(d0);
      while (cur <= d1) {
        out.push(new Date(cur));
        cur.setDate(cur.getDate()+1);
      }
      return out;
    }

    function ymd(d) {
      const y = d.getFullYear();
      const m = ('0'+(d.getMonth()+1)).slice(-2);
      const dd = ('0'+d.getDate()).slice(-2);
      return `${y}-${m}-${dd}`;
    }

    // Render
    const $form = document.getElementById('sim-form');
    const $res = document.getElementById('resultado');
    const $kpiDni = document.getElementById('kpi-dni');
    const $kpiRango = document.getElementById('kpi-rango');
    const $kpiObj = document.getElementById('kpi-obj');
    const $acc = document.getElementById('acordeon');
    const $totales = document.getElementById('tabla-totales');

    let lastPlan = null;

    function renderPlan(plan) {
      $kpiDni.textContent = plan.meta.dni;
      $kpiRango.textContent = `${plan.meta.fi} — ${plan.meta.ff}`;
      $kpiObj.textContent = `${plan.meta.kcal} kcal`;
      $acc.innerHTML = '';
      $totales.innerHTML = '';

      // Tabla totales por día
      const tbl = document.createElement('table');
      const thead = document.createElement('thead');
      thead.innerHTML = `
        <tr>
          <th>Fecha</th>
          <th>Kcal</th>
          <th>CHO (g)</th>
          <th>PRO (g)</th>
          <th>FAT (g)</th>
          <th>Fibra (g)</th>
          <th class="small muted">Objetivo (kcal)</th>
        </tr>`;
      tbl.appendChild(thead);
      const tbody = document.createElement('tbody');

      for (const d of plan.dias) {
        const row = document.createElement('tr');
        row.innerHTML = `
          <td>${d.fecha}</td>
          <td>${d.tot.kcal}</td>
          <td>${d.tot.cho}</td>
          <td>${d.tot.pro}</td>
          <td>${d.tot.fat}</td>
          <td>${d.tot.fibra}</td>
          <td class="${Math.abs(d.tot.kcal - plan.meta.kcal) <= 150 ? 'ok' : 'danger'}">${plan.meta.kcal}</td>
        `;
        tbody.appendChild(row);
      }
      tbl.appendChild(tbody);
      $totales.appendChild(tbl);

      // Acordeón por día
      for (const d of plan.dias) {
        const det = document.createElement('details');
        det.open = false;
        const sum = document.createElement('summary');
        sum.innerHTML = `<span style="margin-right:8px; font-weight:600;">${d.fecha}</span> <span class="muted">Total: ${d.tot.kcal} kcal — CHO ${d.tot.cho}g · PRO ${d.tot.pro}g · FAT ${d.tot.fat}g · Fibra ${d.tot.fibra}g</span>`;
        det.appendChild(sum);

        for (const meal of MEALS) {
          const box = document.createElement('div');
          box.className = 'card mt-2';
          const comp = d.comidas[meal];
          const itemsHtml = comp.items.map(x => `
            <tr>
              <td>${x.label}</td>
              <td class="right">${x.kcal}</td>
              <td class="right">${x.cho}</td>
              <td class="right">${x.pro}</td>
              <td class="right">${x.fat}</td>
              <td class="right">${x.fibra}</td>
            </tr>
          `).join('');
          box.innerHTML = `
            <h3 class="mb-2">${meal} <span class="muted small">(~${comp.target} kcal objetivo)</span></h3>
            <table>
              <thead>
                <tr>
                  <th>Alimento</th><th>Kcal</th><th>CHO</th><th>PRO</th><th>FAT</th><th>Fibra</th>
                </tr>
              </thead>
              <tbody>${itemsHtml}</tbody>
              <tfoot>
                <tr>
                  <th>Total</th>
                  <th class="right">${comp.tot.kcal}</th>
                  <th class="right">${comp.tot.cho}</th>
                  <th class="right">${comp.tot.pro}</th>
                  <th class="right">${comp.tot.fat}</th>
                  <th class="right">${comp.tot.fibra}</th>
                </tr>
              </tfoot>
            </table>
          `;
          det.appendChild(box);
        }
        $acc.appendChild(det);
      }
    }

    function buildPlan(formValues) {
      const {dni, fi, ff, kcal, prefs, alergias} = formValues;
      const dias = [];
      const calendar = rangos(fi, ff);
      for (const day of calendar) {
        const planDia = generarDia(kcal, prefs, alergias);
        // Totales por día
        let tot = {kcal:0,cho:0,pro:0,fat:0,fibra:0};
        for (const meal of MEALS) {
          const t = planDia[meal].tot;
          tot.kcal += t.kcal; tot.cho += t.cho; tot.pro += t.pro; tot.fat += t.fat; tot.fibra += t.fibra;
        }
        for (const k of Object.keys(tot)) tot[k] = +tot[k].toFixed(1);

        dias.push({
          fecha: ymd(day),
          comidas: planDia,
          tot
        });
      }
      return {
        meta: {dni, fi, ff, kcal},
        dias
      };
    }

    function getFormValues() {
      const fd = new FormData($form);
      const dni = (fd.get('dni')||'').trim();
      const fi = fd.get('fi');
      const ff = fd.get('ff');
      const kcal = parseInt(fd.get('kcal'), 10);
      const actividad = fd.get('actividad');
      const prefs = {
        sin_lacteos: !!fd.get('pref_sin_lacteos'),
        vegetariano: !!fd.get('pref_vegetariano'),
        bajo_ig: !!fd.get('pref_bajo_ig'),
        alta_fibra: !!fd.get('pref_alta_fibra'),
        actividad
      };
      const alergias = (fd.get('alergias')||'')
        .toLowerCase()
        .split(',')
        .map(x=>x.trim())
        .filter(Boolean);
      return {dni, fi, ff, kcal, prefs, alergias};
    }

    $form.addEventListener('submit', (e)=>{
      e.preventDefault();
      const vals = getFormValues();
      if (!vals.dni || !vals.fi || !vals.ff) return alert('Completa DNI y rango de fechas.');
      if (new Date(vals.fi) > new Date(vals.ff)) return alert('La fecha inicio no puede ser mayor que la fecha fin.');
      lastPlan = buildPlan(vals);
      renderPlan(lastPlan);
      document.getElementById('resultado').classList.remove('hidden');
      window.scrollTo({top: document.getElementById('resultado').offsetTop - 8, behavior:'smooth'});
    });

    document.getElementById('btn-limpiar').addEventListener('click', ()=>{
      $form.reset();
      document.getElementById('resultado').classList.add('hidden');
    });

    document.getElementById('btn-top').addEventListener('click',(e)=>{
      e.preventDefault();
      window.scrollTo({top:0, behavior:'smooth'});
    });

    document.getElementById('btn-regenerar').addEventListener('click', ()=>{
      if (!lastPlan) return;
      lastPlan = buildPlan(lastPlan.meta); // re-genera con misma meta
      renderPlan(lastPlan);
    });

    document.getElementById('btn-pdf').addEventListener('click', ()=>{
      window.print();
    });

    document.getElementById('btn-guardar').addEventListener('click', ()=>{
      alert('Guardado simulado: este botón no persiste datos en BD.');
    });

    document.getElementById('btn-copiar').addEventListener('click', async ()=>{
      if (!lastPlan) return;
      try {
        await navigator.clipboard.writeText(JSON.stringify(lastPlan, null, 2));
        alert('Plan en JSON copiado al portapapeles.');
      } catch (e) {
        alert('No se pudo copiar. Revisa permisos del navegador.');
      }
    });
  </script>
</body>
</html>
