{% extends "admin/base_admin.html" %}
{% set page_title = "NutriSync ¬∑ Usuarios" %}
{% set header_title = "Usuarios" %}
{% set active_nav = "usuarios" %}

{% block content %}
<div class="toolbar" style="justify-content: space-between; gap:10px;">
  <button id="btnNuevoUsuario" class="btn btn-primary">
    <i class="fas fa-plus"></i> Nuevo usuario
  </button>

  <!-- üîé Buscador por email -->
  <div class="searchbox" style="min-width:360px;">
    <i class="fas fa-search"></i>
    <input id="buscarUsuarioInput" type="text" placeholder="Buscar usuario por email...">
    <button id="btnClearUsuario" class="clear" title="Limpiar">√ó</button>
  </div>
</div>

<div class="card">
  <div class="card-header">
    <h3><i class="fas fa-users-cog"></i> Lista de usuarios</h3>
  </div>
  <div class="card-body">
    <div class="table-responsive">
      <!-- üîÑ Render din√°mico -->
      <div id="tablaUsuarios"></div>
      <div id="paginacionUsuarios" class="pagination"></div>
    </div>
  </div>
</div>

<!-- ============ MODAL: USUARIO (nuevo/editar) ============ -->
<div class="modal" id="modalUsuario" aria-hidden="true">
  <div class="modal-backdrop js-close-modal" data-target="#modalUsuario"></div>
  <div class="modal-dialog">
    <div class="modal-header">
      <h3 id="modalUsuarioTitulo"><i class="fas fa-user-cog"></i> Usuario</h3>
      <button class="modal-close js-close-modal" data-target="#modalUsuario" aria-label="Cerrar">√ó</button>
    </div>
    <form id="formUsuario" method="post">
      <div class="modal-body">
        <div class="form-row">
          <label for="u_email">Email <span style="color: #ef4444;">*</span></label>
          <input type="email" name="email" id="u_email" required>
          <div id="errorEmail" style="color: #ef4444; font-size: 13px; margin-top: 5px; padding-left: 2px; display: none; font-weight: 500;"></div>
        </div>

        <div class="form-row">
          <label for="u_estado">Estado <span style="color: #ef4444;">*</span></label>
          <select name="estado" id="u_estado" required>
            <option value="activo">activo</option>
            <option value="bloqueado">bloqueado</option>
          </select>
          <div id="errorEstado" style="color: #ef4444; font-size: 13px; margin-top: 5px; padding-left: 2px; display: none; font-weight: 500;"></div>
        </div>

        <div class="form-row">
          <label>Rol <span style="color: #ef4444;">*</span></label>
          <div class="roles-radio-group" id="rolesGroup">
            {% for r in all_roles %}
            <label class="radio-option">
              <input type="radio" name="rol" value="{{ r[0] }}" id="rol_{{ r[0] }}" required>
              <span>{{ r[1] }}</span>
            </label>
            {% endfor %}
          </div>
          <div id="errorRol" style="color: #ef4444; font-size: 13px; margin-top: 5px; padding-left: 2px; display: none; font-weight: 500;"></div>
        </div>

        <div class="form-row">
          <label for="u_password">Contrase√±a <span id="pwdRequired" style="color: #ef4444;">*</span></label>
          <div style="position: relative;">
            <input type="text" name="password" id="u_password" placeholder="" required autocomplete="new-password" data-form-type="other" style="-webkit-text-security: disc; -moz-text-security: disc; text-security: disc; padding-right: 45px; width: 100%;">
            <button type="button" class="toggle-password-btn" id="togglePassword" aria-label="Mostrar u ocultar contrase√±a" style="position: absolute; right: 12px; top: 50%; transform: translateY(-50%); background: none; border: none; cursor: pointer; color: #6b7280; padding: 4px; font-size: 16px;">
              <i class="fas fa-eye"></i>
            </button>
          </div>
          <small class="muted" id="u_pwd_help"></small>
          <div id="errorPassword" style="color: #ef4444; font-size: 13px; margin-top: 5px; padding-left: 2px; display: none; font-weight: 500;"></div>
        </div>

        <div class="form-row" id="confirmPasswordRow" style="display: none;">
          <label for="u_password_confirm">Confirmar Contrase√±a <span id="pwdConfirmRequired" style="color: #ef4444;">*</span></label>
          <div style="position: relative;">
            <input type="text" name="password_confirm" id="u_password_confirm" placeholder="" autocomplete="new-password" data-form-type="other" style="-webkit-text-security: disc; -moz-text-security: disc; text-security: disc; padding-right: 45px; width: 100%;">
            <button type="button" class="toggle-password-btn" id="togglePasswordConfirm" aria-label="Mostrar u ocultar contrase√±a" style="position: absolute; right: 12px; top: 50%; transform: translateY(-50%); background: none; border: none; cursor: pointer; color: #6b7280; padding: 4px; font-size: 16px;">
              <i class="fas fa-eye"></i>
            </button>
          </div>
          <div id="errorPasswordConfirm" style="color: #ef4444; font-size: 13px; margin-top: 5px; padding-left: 2px; display: none; font-weight: 500;"></div>
        </div>
      </div>

      <div class="modal-footer">
        <button type="button" class="btn js-close-modal" data-target="#modalUsuario">Cancelar</button>
        <button type="submit" class="btn btn-primary">Guardar</button>
      </div>
    </form>
  </div>
</div>

<!-- ============ MODAL: CONFIRMAR ELIMINAR USUARIO ============ -->
<div class="modal" id="modalConfirmarBorrarUsuario" aria-hidden="true">
  <div class="modal-backdrop js-close-modal" data-target="#modalConfirmarBorrarUsuario"></div>
  <div class="modal-dialog">
    <div class="modal-header">
      <h3><i class="fas fa-exclamation-triangle"></i> Confirmar eliminaci√≥n</h3>
      <button class="modal-close js-close-modal" data-target="#modalConfirmarBorrarUsuario" aria-label="Cerrar">√ó</button>
    </div>
    <div class="modal-body">
      <p>¬øEst√° seguro de eliminar el usuario <strong id="emailUsuarioBorrar"></strong>?</p>
      <p class="muted" style="margin-top: 10px; color: #6b7280;">Esto eliminar√° el usuario y todos sus datos asociados permanentemente.</p>
    </div>
    <div class="modal-footer">
      <button type="button" class="btn js-close-modal" data-target="#modalConfirmarBorrarUsuario">Cancelar</button>
      <form id="formConfirmarBorrarUsuario" method="post" style="display:inline-block">
        <button type="submit" class="btn btn-danger">
          <i class="fas fa-trash"></i> S√≠, eliminar
        </button>
      </form>
    </div>
  </div>
</div>

<!-- Dependencies -->
<link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet">
<script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/toastify-js@1.12.0/src/toastify.min.js"></script>
<link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/toastify-js@1.12.0/src/toastify.min.css">

<style>
  /* ===== ESTILOS MODERNOS PARA USUARIOS ===== */
  
  /* Tabla compacta y moderna */
  .tbl {
    width: 100%;
    border-collapse: collapse;
    background: white;
    border-radius: 12px;
    overflow: hidden;
    box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
    font-size: 14px;
  }
  
  .tbl th {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    padding: 16px 12px;
    text-align: left;
    font-weight: 600;
    font-size: 13px;
    text-transform: uppercase;
    letter-spacing: 0.5px;
  }
  
  .tbl td {
    padding: 14px 12px;
    border-bottom: 1px solid #f1f5f9;
    vertical-align: middle;
  }
  
  .tbl tbody tr:hover {
    background: linear-gradient(90deg, #f8fafc 0%, #e2e8f0 100%);
    transform: translateY(-1px);
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
  }
  
  /* Badges modernos */
  .badge {
    display: inline-block;
    padding: 6px 12px;
    border-radius: 20px;
    font-size: 11px;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.5px;
  }
  
  .badge.ok {
    background: linear-gradient(135deg, #10b981, #059669);
    color: white;
    box-shadow: 0 2px 4px rgba(16, 185, 129, 0.3);
  }
  
  .badge.warn {
    background: linear-gradient(135deg, #f59e0b, #d97706);
    color: white;
    box-shadow: 0 2px 4px rgba(245, 158, 11, 0.3);
  }
  
  /* Botones de acci√≥n modernos */
  .actions {
    display: flex;
    gap: 8px;
    align-items: center;
    flex-wrap: wrap;
  }
  
  .actions .btn {
    padding: 8px 12px;
    border-radius: 8px;
    font-size: 12px;
    font-weight: 500;
    border: none;
    cursor: pointer;
    transition: all 0.2s ease;
    display: flex;
    align-items: center;
    gap: 6px;
  }
  
  .actions .btn-sm {
    padding: 6px 10px;
    font-size: 11px;
  }
  
  .actions .btn-primary {
    background: linear-gradient(135deg, #3b82f6, #2563eb);
    color: white;
    box-shadow: 0 2px 4px rgba(59, 130, 246, 0.3);
  }
  
  .actions .btn-primary:hover {
    transform: translateY(-1px);
    box-shadow: 0 4px 8px rgba(59, 130, 246, 0.4);
  }
  
  .actions .btn-danger {
    background: linear-gradient(135deg, #ef4444, #dc2626);
    color: white;
    box-shadow: 0 2px 4px rgba(239, 68, 68, 0.3);
  }
  
  .actions .btn-danger:hover {
    transform: translateY(-1px);
    box-shadow: 0 4px 8px rgba(239, 68, 68, 0.4);
  }
  
  /* Paginaci√≥n moderna */
  .pagination {
    display: flex;
    justify-content: center;
    align-items: center;
    gap: 8px;
    margin-top: 20px;
    padding: 16px;
  }
  
  .pagination button {
    padding: 10px 16px;
    border: 2px solid #e2e8f0;
    background: white;
    border-radius: 8px;
    cursor: pointer;
    font-weight: 500;
    transition: all 0.2s ease;
    color: #64748b;
  }
  
  .pagination button:hover {
    border-color: #3b82f6;
    color: #3b82f6;
    transform: translateY(-1px);
  }
  
  .pagination button.active {
    background: linear-gradient(135deg, #3b82f6, #2563eb);
    color: white;
    border-color: #3b82f6;
    box-shadow: 0 2px 4px rgba(59, 130, 246, 0.3);
  }
  
  /* Modal mejorado */
  .modal-dialog {
    background: white;
    border-radius: 16px;
    box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
    border: 1px solid #e2e8f0;
  }
  
  .modal-header {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    padding: 20px 24px;
    border-radius: 16px 16px 0 0;
  }
  
  .modal-header h3 {
    margin: 0;
    font-size: 18px;
    font-weight: 600;
  }
  
  .modal-body {
    padding: 24px;
  }
  
  .form-row {
    margin-bottom: 20px;
  }
  
  .form-row label {
    display: block;
    margin-bottom: 8px;
    font-weight: 500;
    color: #374151;
  }
  
  .form-row input,
  .form-row select {
    width: 100%;
    padding: 12px 16px;
    border: 2px solid #e5e7eb;
    border-radius: 8px;
    font-size: 14px;
    transition: border-color 0.2s ease;
    box-sizing: border-box;
  }
  
  /* Ocultar botones nativos de revelar contrase√±a del navegador */
  .form-row input[type="password"]::-webkit-credentials-auto-fill-button,
  .form-row input[type="password"]::-webkit-strong-password-auto-fill-button {
    display: none !important;
    visibility: hidden !important;
    opacity: 0 !important;
    pointer-events: none !important;
  }
  
  /* Ocultar cualquier bot√≥n o √≠cono que el navegador pueda agregar */
  .form-row input[type="password"]::after,
  .form-row input[type="password"]::before {
    display: none !important;
    content: none !important;
  }
  
  .form-row select {
    min-height: 48px;
    appearance: none;
    background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='currentColor' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3e%3cpolyline points='6,9 12,15 18,9'%3e%3c/polyline%3e%3c/svg%3e");
    background-repeat: no-repeat;
    background-position: right 12px center;
    background-size: 16px;
    padding-right: 40px;
  }
  
  .form-row input:focus,
  .form-row select:focus {
    outline: none;
    border-color: #3b82f6;
    box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
  }
  
  .checkbox-label {
    display: flex;
    align-items: center;
    gap: 8px;
    cursor: pointer;
  }
  
  .checkbox-label input[type="checkbox"] {
    width: auto;
    margin: 0;
  }
  
  /* Estilos para radio buttons de roles */
  .roles-radio-group {
    display: flex;
    flex-direction: column;
    gap: 10px;
    margin-top: 8px;
  }
  
  .radio-option {
    display: flex;
    align-items: center;
    gap: 10px;
    padding: 12px 16px;
    border: 2px solid #e5e7eb;
    border-radius: 8px;
    cursor: pointer;
    transition: all 0.2s ease;
    background: #ffffff;
  }
  
  .radio-option:hover {
    border-color: #3b82f6;
    background: #f8fafc;
  }
  
  .radio-option input[type="radio"] {
    width: 18px;
    height: 18px;
    margin: 0;
    cursor: pointer;
    accent-color: #3b82f6;
  }
  
  .radio-option input[type="radio"]:checked + span {
    font-weight: 600;
    color: #3b82f6;
  }
  
  .radio-option:has(input[type="radio"]:checked) {
    border-color: #3b82f6;
    background: #eff6ff;
  }
  
  .radio-option span {
    flex: 1;
    font-size: 14px;
    color: #374151;
  }
  
  .modal-footer {
    padding: 20px 24px;
    border-top: 1px solid #e5e7eb;
    display: flex;
    gap: 12px;
    justify-content: flex-end;
  }
  
  .modal-footer .btn {
    padding: 12px 24px;
    border-radius: 8px;
    font-weight: 500;
    border: none;
    cursor: pointer;
    transition: all 0.2s ease;
  }
  
  .modal-footer .btn-primary {
    background: linear-gradient(135deg, #3b82f6, #2563eb);
    color: white;
  }
  
  .modal-footer .btn-primary:hover {
    transform: translateY(-1px);
    box-shadow: 0 4px 8px rgba(59, 130, 246, 0.3);
  }
  
  /* Grid de roles */
  .roles-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 12px;
  }
  
  .roles-grid .chk {
    display: flex;
    align-items: center;
    gap: 8px;
    padding: 12px;
    border: 2px solid #e5e7eb;
    border-radius: 8px;
    cursor: pointer;
    transition: all 0.2s ease;
  }
  
  .roles-grid .chk:hover {
    border-color: #3b82f6;
    background: #f8fafc;
  }
  
  .roles-grid .chk input[type="checkbox"] {
    width: auto;
    margin: 0;
  }
  
  /* Responsive */
  @media (max-width: 768px) {
    .tbl {
      font-size: 12px;
    }
    
    .tbl th, .tbl td {
      padding: 8px 6px;
    }
    
    .actions {
      flex-direction: column;
      gap: 4px;
    }
    
    .actions .btn {
      width: 100%;
      justify-content: center;
    }
    
    .modal-dialog {
      margin: 20px;
      width: calc(100% - 40px);
    }
  }
</style>

<script>
  // ====== Estado paginaci√≥n/filtro ======
  const perPageU = 10;
  let currentPageU = 1;
  let currentQueryU = ""; // fragmento de email

  // ====== Carga/paginaci√≥n por AJAX ======
  async function cargarUsuarios(page = 1, q = "") {
    const tabla = document.getElementById("tablaUsuarios");
    const pagin = document.getElementById("paginacionUsuarios");
    tabla.innerHTML = "<p>Cargando...</p>";
    const url = `/api/usuarios/page?page=${page}&per_page=${perPageU}&q=${encodeURIComponent(q)}`;
    try {
      const res = await fetch(url);
      if (!res.ok) throw new Error("HTTP " + res.status);
      const data = await res.json();
      renderTablaUsuarios(data.rows);
      renderPaginacionUsuarios(data.total_pages, page, q);
    } catch (e) {
      tabla.innerHTML = "<p>Error cargando usuarios.</p>";
      pagin.innerHTML = "";
    }
  }

  function renderTablaUsuarios(rows = []) {
    const cont = document.getElementById("tablaUsuarios");
    if (!rows.length) {
      cont.innerHTML = "<p class='empty'>No hay usuarios registrados.</p>";
      return;
    }

    let html = `
      <table class="tbl">
        <thead>
          <tr>
            <th>ID</th><th>Email</th><th>Estado</th><th>Rol</th><th style="width:180px;">Acciones</th>
          </tr>
        </thead>
        <tbody>`;

    rows.forEach(u => {
      html += `
        <tr>
          <td>${u.id}</td>
          <td>${u.email}</td>
          <td><span class="badge ${u.estado==='activo' ? 'ok' : 'warn'}">${u.estado}</span></td>
          <td>${u.roles || 'Sin rol'}</td>
          <td class="actions">
            <button class="btn btn-sm js-edit" data-id="${u.id}" data-email="${u.email}" data-estado="${u.estado}" data-rol="${u.rol_id || ''}">
              <i class="fas fa-edit"></i> Editar
            </button>
            <button class="btn btn-sm btn-danger js-borrar" data-id="${u.id}" data-email="${u.email}">
              <i class="fas fa-trash"></i> Borrar
            </button>
          </td>
        </tr>`;
    });

    html += `</tbody></table>`;
    cont.innerHTML = html;

    // Re-bind de acciones porque la tabla se recrea
    bindAccionesUsuarios();
  }

  function renderPaginacionUsuarios(total, actual, q) {
    const cont = document.getElementById("paginacionUsuarios");
    if (total <= 1) { cont.innerHTML = ""; return; }
    let html = "";
    for (let i = 1; i <= total; i++) {
      html += `<button class="${i===actual?'active':''}" data-page="${i}">${i}</button>`;
    }
    cont.innerHTML = html;
    cont.querySelectorAll("button").forEach(b => {
      b.addEventListener("click", () => {
        currentPageU = parseInt(b.dataset.page);
        cargarUsuarios(currentPageU, currentQueryU);
      });
    });
  }

  // ====== Select2 (buscar por email) ======
  $(document).ready(function () {
    // Configurar el input de b√∫squeda
    const buscarInput = document.getElementById('buscarUsuarioInput');
    const btnClear = document.getElementById('btnClearUsuario');
    
    let searchTimeout;
    
    buscarInput.addEventListener('input', function() {
      clearTimeout(searchTimeout);
      const query = this.value.trim();
      
      if (query.length >= 2) {
        searchTimeout = setTimeout(() => {
          cargarUsuarios(1, query);
        }, 300);
      } else if (query.length === 0) {
        cargarUsuarios(1, '');
      }
      
      btnClear.style.visibility = query ? 'visible' : 'hidden';
    });
    
    btnClear.addEventListener('click', function() {
      buscarInput.value = '';
      cargarUsuarios(1, '');
      btnClear.style.visibility = 'hidden';
      buscarInput.focus();
    });
    
    btnClear.style.visibility = 'hidden';
  });

  // ====== Util modales ======
  const openModal  = sel => document.querySelector(sel).classList.add('open');
  const closeModal = sel => document.querySelector(sel).classList.remove('open');
  document.querySelectorAll('.js-close-modal').forEach(b => {
    b.addEventListener('click', () => closeModal(b.dataset.target));
  });

  // ====== Manejar env√≠o del formulario de borrar ======
  document.getElementById('formConfirmarBorrarUsuario')?.addEventListener('submit', async function(e) {
    e.preventDefault();
    const form = this;
    const formData = new FormData(form);
    
    try {
      const response = await fetch(form.action, {
        method: 'POST',
        body: formData
      });
      
      if (response.ok) {
        // Cerrar el modal
        closeModal('#modalConfirmarBorrarUsuario');
        
        // Mostrar mensaje de √©xito
        Toastify({
          text: "‚úÖ Usuario borrado correctamente",
          duration: 3000,
          gravity: "top",
          position: "right",
          backgroundColor: "#10b981",
        }).showToast();
        
        // Recargar la tabla
        cargarUsuarios(currentPageU, currentQueryU);
      } else {
        const errorText = await response.text();
        Toastify({
          text: "‚ùå Error al borrar el usuario",
          duration: 3000,
          gravity: "top",
          position: "right",
          backgroundColor: "#ef4444",
        }).showToast();
      }
    } catch (error) {
      Toastify({
        text: "‚ùå Error de conexi√≥n",
        duration: 3000,
        gravity: "top",
        position: "right",
        backgroundColor: "#ef4444",
      }).showToast();
    }
  });

  // ====== Manejar env√≠o del formulario de usuario ======
  (function() {
    const formUsuario = document.getElementById('formUsuario');
    if (!formUsuario) return;
    
    formUsuario.addEventListener('submit', async function(e) {
      e.preventDefault();
      e.stopPropagation();
      
      const form = this;
      const formData = new FormData(form);
      
      // Obtener divs de error para cada campo
      const errorEmail = document.getElementById('errorEmail');
      const errorEstado = document.getElementById('errorEstado');
      const errorRol = document.getElementById('errorRol');
      const errorPassword = document.getElementById('errorPassword');
      
      // Obtener div de error de confirmaci√≥n de contrase√±a
      const errorPasswordConfirm = document.getElementById('errorPasswordConfirm');
      
      // Funci√≥n para limpiar todos los errores
      function limpiarErrores() {
        if (errorEmail) { errorEmail.style.display = 'none'; errorEmail.textContent = ''; }
        if (errorEstado) { errorEstado.style.display = 'none'; errorEstado.textContent = ''; }
        if (errorRol) { errorRol.style.display = 'none'; errorRol.textContent = ''; }
        if (errorPassword) { errorPassword.style.display = 'none'; errorPassword.textContent = ''; }
        if (errorPasswordConfirm) { errorPasswordConfirm.style.display = 'none'; errorPasswordConfirm.textContent = ''; }
      }
      
      // Limpiar errores anteriores
      limpiarErrores();
      
      // Validaciones del lado del cliente
      const email = formData.get('email')?.trim();
      const password = formData.get('password')?.trim();
      const passwordConfirm = formData.get('password_confirm')?.trim();
      const rol = formData.get('rol');
      const estado = formData.get('estado');
      const isNuevo = form.action.includes('/nuevo');
      
      // Validar email
      if (!email) {
        if (errorEmail) {
          errorEmail.textContent = 'El email es obligatorio';
          errorEmail.style.display = 'block';
        }
        document.getElementById('u_email').focus();
        return;
      }
      
      // Validar formato de email
      const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
      if (!emailRegex.test(email)) {
        if (errorEmail) {
          errorEmail.textContent = 'El formato del email no es v√°lido';
          errorEmail.style.display = 'block';
        }
        document.getElementById('u_email').focus();
        return;
      }
      
      // Validar estado
      if (!estado) {
        if (errorEstado) {
          errorEstado.textContent = 'Debe seleccionar un estado';
          errorEstado.style.display = 'block';
        }
        document.getElementById('u_estado').focus();
        return;
      }
      
      // Validar rol
      if (!rol) {
        if (errorRol) {
          errorRol.textContent = 'Debe seleccionar un rol';
          errorRol.style.display = 'block';
        }
        const firstRadio = document.querySelector('input[name="rol"]');
        if (firstRadio) firstRadio.focus();
        return;
      }
      
      // Validar contrase√±a (solo al crear)
      if (isNuevo && !password) {
        if (errorPassword) {
          errorPassword.textContent = 'La contrase√±a es obligatoria para crear un nuevo usuario';
          errorPassword.style.display = 'block';
        }
        document.getElementById('u_password').focus();
        return;
      }
      
      // Validar confirmaci√≥n de contrase√±a (obligatoria al crear, o si se proporciona contrase√±a al editar)
      if ((isNuevo || password) && !passwordConfirm) {
        if (errorPasswordConfirm) {
          errorPasswordConfirm.textContent = 'Debe confirmar la contrase√±a';
          errorPasswordConfirm.style.display = 'block';
        }
        document.getElementById('u_password_confirm').focus();
        return;
      }
      
      // Validar longitud m√≠nima de contrase√±a (si se proporciona)
      if (password && password.length < 6) {
        if (errorPassword) {
          errorPassword.textContent = 'La contrase√±a debe tener al menos 6 caracteres';
          errorPassword.style.display = 'block';
        }
        document.getElementById('u_password').focus();
        return;
      }
      
      // Validar que las contrase√±as coincidan (solo al crear o si se proporciona contrase√±a al editar)
      if ((isNuevo || password) && password !== passwordConfirm) {
        if (errorPasswordConfirm) {
          errorPasswordConfirm.textContent = 'Las contrase√±as no coinciden';
          errorPasswordConfirm.style.display = 'block';
        }
        document.getElementById('u_password_confirm').focus();
        return;
      }
      
      try {
        const response = await fetch(form.action, {
          method: 'POST',
          headers: {
            'X-Requested-With': 'XMLHttpRequest',
            'Accept': 'application/json'
          },
          body: formData,
          redirect: 'manual' // Evitar que el navegador siga redirects autom√°ticamente
        });
        
        // Si la respuesta es un redirect (status 301, 302, etc), el servidor no detect√≥ AJAX
        if (response.type === 'opaqueredirect' || response.status === 302 || response.status === 301) {
          if (errorEmail) {
            errorEmail.textContent = 'Error: El servidor redirigi√≥ la petici√≥n. Por favor, verifica que el correo no est√© duplicado.';
            errorEmail.style.display = 'block';
          }
          return;
        }
        
        // Verificar el Content-Type de la respuesta
        const contentType = response.headers.get('content-type');
        
        // Si la respuesta es HTML en lugar de JSON, el servidor no detect√≥ la petici√≥n AJAX
        if (!contentType || !contentType.includes('application/json')) {
          // Si es un error (400, 500, etc), intentar leer el texto
          if (!response.ok) {
            const errorText = await response.text();
            // Intentar extraer el mensaje de error si hay uno
            if (errorEmail) {
              errorEmail.textContent = 'Error al guardar el usuario. Por favor, verifica que el correo no est√© duplicado.';
              errorEmail.style.display = 'block';
            }
            return;
          }
          // Si no es JSON, mostrar error gen√©rico
          if (errorEmail) {
            errorEmail.textContent = 'Error: El servidor no proces√≥ la petici√≥n correctamente.';
            errorEmail.style.display = 'block';
          }
          return;
        }
        
        let data;
        try {
          const responseText = await response.text();
          // Intentar parsear como JSON
          try {
            data = JSON.parse(responseText);
          } catch (parseError) {
            // Si no es JSON, el servidor devolvi√≥ HTML o texto
            console.error('El servidor no devolvi√≥ JSON:', responseText.substring(0, 200));
            // Si el servidor devolvi√≥ un error, intentar mostrar un mensaje √∫til
            if (errorEmail) {
              if (response.status === 400 || response.status === 500) {
                errorEmail.textContent = 'El correo electr√≥nico ya est√° registrado o hay un error en el servidor.';
              } else {
                errorEmail.textContent = 'Error al procesar la respuesta del servidor. Por favor, intenta de nuevo.';
              }
              errorEmail.style.display = 'block';
            }
            return;
          }
        } catch (error) {
          console.error('Error al leer la respuesta:', error);
          if (errorEmail) {
            errorEmail.textContent = 'Error de conexi√≥n con el servidor';
            errorEmail.style.display = 'block';
          }
          return;
        }
        
        if (data.ok) {
          // Cerrar el modal
          closeModal('#modalUsuario');
          
          // Mostrar mensaje de √©xito
          Toastify({
            text: "‚úÖ Usuario guardado correctamente",
            duration: 3000,
            gravity: "top",
            position: "right",
            backgroundColor: "#10b981",
          }).showToast();
          
          // Recargar la tabla
          cargarUsuarios(currentPageU, currentQueryU);
        } else {
          // Mostrar error. Si es error de email, mostrarlo en errorEmail, sino en errorEmail tambi√©n
          const errorMsg = data.error || 'Error al guardar el usuario';
          if (errorEmail) {
            // Detectar si es error de email o contrase√±a
            if (errorMsg.toLowerCase().includes('correo') || errorMsg.toLowerCase().includes('email')) {
              errorEmail.textContent = errorMsg;
              errorEmail.style.display = 'block';
            } else if (errorMsg.toLowerCase().includes('contrase√±a') || errorMsg.toLowerCase().includes('password')) {
              if (errorPassword) {
                errorPassword.textContent = errorMsg;
                errorPassword.style.display = 'block';
              }
            } else {
              errorEmail.textContent = errorMsg;
              errorEmail.style.display = 'block';
            }
          }
        }
      } catch (error) {
        console.error('Error en submit:', error);
        if (errorEmail) {
          errorEmail.textContent = 'Error de conexi√≥n';
          errorEmail.style.display = 'block';
        }
      }
    });
  })();

  // ====== Nuevo usuario ======
  document.getElementById('btnNuevoUsuario')?.addEventListener('click', () => {
    const f = document.getElementById('formUsuario');
    f.action = "{{ url_for('admin_usuario_nuevo') }}";
    document.getElementById('modalUsuarioTitulo').innerText = "Nuevo usuario";
    document.getElementById('u_email').value = "";
    document.getElementById('u_estado').value = "activo";
    // Limpiar selecci√≥n de roles
    document.querySelectorAll('input[name="rol"]').forEach(radio => {
      radio.checked = false;
    });
    document.getElementById('u_password').value = "";
    document.getElementById('u_password').required = true;
    document.getElementById('pwdRequired').style.display = 'inline';
    document.getElementById('u_pwd_help').innerText = "";
    // Mostrar campo de confirmaci√≥n de contrase√±a
    const confirmPasswordRow = document.getElementById('confirmPasswordRow');
    const passwordConfirmInput = document.getElementById('u_password_confirm');
    const pwdConfirmRequired = document.getElementById('pwdConfirmRequired');
    if (confirmPasswordRow) confirmPasswordRow.style.display = 'block';
    if (passwordConfirmInput) {
      passwordConfirmInput.value = "";
      passwordConfirmInput.required = true;
    }
    if (pwdConfirmRequired) pwdConfirmRequired.style.display = 'inline';
    // Limpiar errores
    const errorEmail = document.getElementById('errorEmail');
    const errorPassword = document.getElementById('errorPassword');
    const errorPasswordConfirm = document.getElementById('errorPasswordConfirm');
    const errorEstado = document.getElementById('errorEstado');
    const errorRol = document.getElementById('errorRol');
    if (errorEmail) { errorEmail.style.display = 'none'; errorEmail.textContent = ''; }
    if (errorPassword) { errorPassword.style.display = 'none'; errorPassword.textContent = ''; }
    if (errorPasswordConfirm) { errorPasswordConfirm.style.display = 'none'; errorPasswordConfirm.textContent = ''; }
    if (errorEstado) { errorEstado.style.display = 'none'; errorEstado.textContent = ''; }
    if (errorRol) { errorRol.style.display = 'none'; errorRol.textContent = ''; }
    openModal('#modalUsuario');
  });

  // ====== Re-bind acciones de la tabla ======
  function bindAccionesUsuarios() {
    // Editar
    document.querySelectorAll('.js-edit').forEach(btn => {
      btn.addEventListener('click', async () => {
        const uid = btn.dataset.id;
        const email = btn.dataset.email;
        const estado = btn.dataset.estado;
        const rolId = btn.dataset.rol;

        const f = document.getElementById('formUsuario');
        f.action = "{{ url_for('admin_usuario_editar', uid=0) }}".replace('/0/', '/' + uid + '/');
        document.getElementById('modalUsuarioTitulo').innerText = "Editar usuario";
        document.getElementById('u_email').value = email;
        document.getElementById('u_estado').value = estado;
        
        // Marcar el rol actual
        document.querySelectorAll('input[name="rol"]').forEach(radio => {
          radio.checked = radio.value === rolId;
        });
        
        document.getElementById('u_password').value = "";
        document.getElementById('u_password').required = false;
        document.getElementById('pwdRequired').style.display = 'none';
        document.getElementById('u_pwd_help').innerText = "Deja vac√≠o para no cambiar la contrase√±a.";
        // Mostrar campo de confirmaci√≥n solo si se va a cambiar la contrase√±a
        const confirmPasswordRow = document.getElementById('confirmPasswordRow');
        const passwordConfirmInput = document.getElementById('u_password_confirm');
        const pwdConfirmRequired = document.getElementById('pwdConfirmRequired');
        if (confirmPasswordRow) confirmPasswordRow.style.display = 'block';
        if (passwordConfirmInput) {
          passwordConfirmInput.value = "";
          passwordConfirmInput.required = false;
        }
        if (pwdConfirmRequired) pwdConfirmRequired.style.display = 'none';
        
        // Agregar listener para hacer obligatorio el campo de confirmaci√≥n si se escribe contrase√±a
        const passwordInput = document.getElementById('u_password');
        if (passwordInput && passwordConfirmInput) {
          // Remover listener anterior si existe usando una funci√≥n nombrada
          const handler = function() {
            if (passwordInput.value && passwordConfirmInput) {
              passwordConfirmInput.required = true;
              if (pwdConfirmRequired) pwdConfirmRequired.style.display = 'inline';
            } else if (!passwordInput.value && passwordConfirmInput) {
              passwordConfirmInput.required = false;
              if (pwdConfirmRequired) pwdConfirmRequired.style.display = 'none';
              passwordConfirmInput.value = '';
              const errorPasswordConfirm = document.getElementById('errorPasswordConfirm');
              if (errorPasswordConfirm) {
                errorPasswordConfirm.style.display = 'none';
                errorPasswordConfirm.textContent = '';
              }
            }
          };
          
          // Remover listener anterior si existe
          passwordInput.removeEventListener('input', passwordInput._passwordHandler);
          passwordInput._passwordHandler = handler;
          passwordInput.addEventListener('input', handler);
        }
        
        // Limpiar errores
        const errorEmail = document.getElementById('errorEmail');
        const errorPassword = document.getElementById('errorPassword');
        const errorPasswordConfirm = document.getElementById('errorPasswordConfirm');
        const errorEstado = document.getElementById('errorEstado');
        const errorRol = document.getElementById('errorRol');
        if (errorEmail) { errorEmail.style.display = 'none'; errorEmail.textContent = ''; }
        if (errorPassword) { errorPassword.style.display = 'none'; errorPassword.textContent = ''; }
        if (errorPasswordConfirm) { errorPasswordConfirm.style.display = 'none'; errorPasswordConfirm.textContent = ''; }
        if (errorEstado) { errorEstado.style.display = 'none'; errorEstado.textContent = ''; }
        if (errorRol) { errorRol.style.display = 'none'; errorRol.textContent = ''; }
        openModal('#modalUsuario');
      });
    });

    // Borrar con modal de confirmaci√≥n
    document.querySelectorAll('.js-borrar').forEach(btn => {
      btn.addEventListener('click', () => {
        const uid = btn.dataset.id;
        const email = btn.dataset.email;
        
        // Configurar el modal
        document.getElementById('emailUsuarioBorrar').textContent = email;
        const form = document.getElementById('formConfirmarBorrarUsuario');
        form.action = `/admin/usuarios/${uid}/borrar`;
        
        // Mostrar el modal
        document.querySelector('#modalConfirmarBorrarUsuario').classList.add('open');
      });
    });
  }


  // ====== Asegurar que los campos de contrase√±a usen text-security ======
  function ensurePasswordSecurity() {
    const passwordInput = document.getElementById('u_password');
    const passwordConfirmInput = document.getElementById('u_password_confirm');
    
    [passwordInput, passwordConfirmInput].forEach(input => {
      if (input && input.type === 'text') {
        // Asegurar que tenga el estilo de text-security
        if (!input.style.webkitTextSecurity && !input.style.textSecurity) {
          input.style.webkitTextSecurity = 'disc';
          input.style.mozTextSecurity = 'disc';
          input.style.textSecurity = 'disc';
        }
      }
    });
  }
  
  // ====== Funciones para mostrar/ocultar contrase√±a ======
  function initTogglePassword() {
    // Bot√≥n para contrase√±a principal
    const togglePassword = document.getElementById('togglePassword');
    const passwordInput = document.getElementById('u_password');
    
    if (togglePassword && passwordInput) {
      // Remover listener anterior si existe
      if (togglePassword._clickHandler) {
        togglePassword.removeEventListener('click', togglePassword._clickHandler);
      }
      
      togglePassword._clickHandler = function(e) {
        e.preventDefault();
        e.stopPropagation();
        const isHidden = passwordInput.style.webkitTextSecurity === 'disc' || 
                        passwordInput.style.textSecurity === 'disc' ||
                        (!passwordInput.style.webkitTextSecurity && !passwordInput.style.textSecurity);
        
        if (isHidden) {
          // Mostrar contrase√±a
          passwordInput.style.webkitTextSecurity = 'none';
          passwordInput.style.mozTextSecurity = 'none';
          passwordInput.style.textSecurity = 'none';
          const icon = togglePassword.querySelector('i');
          if (icon) {
            icon.className = 'fas fa-eye-slash';
          }
        } else {
          // Ocultar contrase√±a
          passwordInput.style.webkitTextSecurity = 'disc';
          passwordInput.style.mozTextSecurity = 'disc';
          passwordInput.style.textSecurity = 'disc';
          const icon = togglePassword.querySelector('i');
          if (icon) {
            icon.className = 'fas fa-eye';
          }
        }
      };
      
      togglePassword.addEventListener('click', togglePassword._clickHandler);
    }
    
    // Bot√≥n para confirmar contrase√±a
    const togglePasswordConfirm = document.getElementById('togglePasswordConfirm');
    const passwordConfirmInput = document.getElementById('u_password_confirm');
    
    if (togglePasswordConfirm && passwordConfirmInput) {
      // Remover listener anterior si existe
      if (togglePasswordConfirm._clickHandler) {
        togglePasswordConfirm.removeEventListener('click', togglePasswordConfirm._clickHandler);
      }
      
      togglePasswordConfirm._clickHandler = function(e) {
        e.preventDefault();
        e.stopPropagation();
        const isHidden = passwordConfirmInput.style.webkitTextSecurity === 'disc' || 
                        passwordConfirmInput.style.textSecurity === 'disc' ||
                        (!passwordConfirmInput.style.webkitTextSecurity && !passwordConfirmInput.style.textSecurity);
        
        if (isHidden) {
          // Mostrar contrase√±a
          passwordConfirmInput.style.webkitTextSecurity = 'none';
          passwordConfirmInput.style.mozTextSecurity = 'none';
          passwordConfirmInput.style.textSecurity = 'none';
          const icon = togglePasswordConfirm.querySelector('i');
          if (icon) {
            icon.className = 'fas fa-eye-slash';
          }
        } else {
          // Ocultar contrase√±a
          passwordConfirmInput.style.webkitTextSecurity = 'disc';
          passwordConfirmInput.style.mozTextSecurity = 'disc';
          passwordConfirmInput.style.textSecurity = 'disc';
          const icon = togglePasswordConfirm.querySelector('i');
          if (icon) {
            icon.className = 'fas fa-eye';
          }
        }
      };
      
      togglePasswordConfirm.addEventListener('click', togglePasswordConfirm._clickHandler);
    }
  }
  
  // Ejecutar cuando se abre el modal
  document.getElementById('btnNuevoUsuario')?.addEventListener('click', function() {
    setTimeout(ensurePasswordSecurity, 100);
    setTimeout(initTogglePassword, 100);
  });
  
  // Ejecutar cuando se edita un usuario
  document.addEventListener('click', function(e) {
    if (e.target.closest('.js-edit')) {
      setTimeout(ensurePasswordSecurity, 100);
      setTimeout(initTogglePassword, 100);
    }
  });
  
  // Ejecutar cuando se hace focus en los campos
  document.getElementById('u_password')?.addEventListener('focus', ensurePasswordSecurity);
  document.getElementById('u_password_confirm')?.addEventListener('focus', ensurePasswordSecurity);
  
  // Inicializar cuando el DOM est√© listo
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', function() {
      ensurePasswordSecurity();
      initTogglePassword();
    });
  } else {
    ensurePasswordSecurity();
    initTogglePassword();
  }

  // ====== Limpiar errores cuando el usuario escribe ======
  document.getElementById('u_email')?.addEventListener('input', function() {
    const errorEmail = document.getElementById('errorEmail');
    if (errorEmail && errorEmail.style.display !== 'none') {
      errorEmail.style.display = 'none';
      errorEmail.textContent = '';
    }
  });
  
  document.getElementById('u_password')?.addEventListener('input', function() {
    const errorPassword = document.getElementById('errorPassword');
    if (errorPassword && errorPassword.style.display !== 'none') {
      errorPassword.style.display = 'none';
      errorPassword.textContent = '';
    }
    // Si hay error de confirmaci√≥n y las contrase√±as coinciden, limpiarlo
    const passwordConfirm = document.getElementById('u_password_confirm');
    const errorPasswordConfirm = document.getElementById('errorPasswordConfirm');
    if (passwordConfirm && errorPasswordConfirm && this.value === passwordConfirm.value) {
      if (errorPasswordConfirm.style.display !== 'none') {
        errorPasswordConfirm.style.display = 'none';
        errorPasswordConfirm.textContent = '';
      }
    }
  });
  
  document.getElementById('u_password_confirm')?.addEventListener('input', function() {
    const errorPasswordConfirm = document.getElementById('errorPasswordConfirm');
    if (errorPasswordConfirm && errorPasswordConfirm.style.display !== 'none') {
      errorPasswordConfirm.style.display = 'none';
      errorPasswordConfirm.textContent = '';
    }
    // Validar en tiempo real si coinciden
    const password = document.getElementById('u_password');
    if (password && this.value && password.value !== this.value) {
      if (errorPasswordConfirm) {
        errorPasswordConfirm.textContent = 'Las contrase√±as no coinciden';
        errorPasswordConfirm.style.display = 'block';
      }
    } else if (password && this.value && password.value === this.value) {
      if (errorPasswordConfirm) {
        errorPasswordConfirm.style.display = 'none';
        errorPasswordConfirm.textContent = '';
      }
    }
  });
  
  document.getElementById('u_estado')?.addEventListener('change', function() {
    const errorEstado = document.getElementById('errorEstado');
    if (errorEstado && errorEstado.style.display !== 'none') {
      errorEstado.style.display = 'none';
      errorEstado.textContent = '';
    }
  });
  
  document.querySelectorAll('input[name="rol"]').forEach(radio => {
    radio.addEventListener('change', function() {
      const errorRol = document.getElementById('errorRol');
      if (errorRol && errorRol.style.display !== 'none') {
        errorRol.style.display = 'none';
        errorRol.textContent = '';
      }
    });
  });

  // ====== Carga inicial ======
  cargarUsuarios();
</script>
{% endblock %}
