# 1.2.3. Desarrollar un modelo de recomendación nutricional personalizado basado en Machine Learning

## Demostración del cumplimiento del objetivo 3

El desarrollo del modelo de recomendación nutricional personalizado se realizó mediante implementación de tres modelos ML especializados que trabajan en conjunto, integración con motor experto basado en reglas clínicas, y desarrollo de sistema de optimización iterativa.

## Arquitectura del modelo

El sistema implementa una arquitectura híbrida que combina tres modelos ML especializados con un motor experto basado en conocimiento clínico.

Modelo 1: Predicción de Respuesta Glucémica: Propósito: Predecir cómo responderá un paciente específico a un alimento específico en términos de respuesta glucémica. Algoritmo: XGBoost Regressor con múltiples targets. Targets: glucose_increment (incremento de glucosa en mg/dL), glucose_peak (pico de glucosa en mg/dL), time_to_peak (tiempo hasta pico en minutos). Features de entrada: Perfil del paciente (edad, sexo, IMC, peso, talla, HbA1c, glucosa en ayunas, triglicéridos, LDL). Características del alimento (kcal, CHO, PRO, FAT, fibra, IG). Features derivadas (CHO por 100 kcal, PRO por 100 kcal, FAT por 100 kcal, fibra por 100 kcal). Contexto (hora del día, tipo de comida, tiempo desde última comida, glucosa baseline). Utilidad: Permite excluir alimentos que causarían picos glucémicos excesivos (mayor a 180 mg/dL) antes de incluirlos en el plan.

Modelo 2: Selección Personalizada de Alimentos: Propósito: Calcular score de idoneidad (0-1) de un alimento específico para un paciente específico. Algoritmo: XGBoost Classifier que clasifica alimentos como adecuados (score mayor a 0.6) o no adecuados (score menor o igual a 0.6). Features de entrada: Perfil del paciente (edad, sexo, IMC, HbA1c, glucosa en ayunas). Características del alimento (kcal, CHO, PRO, FAT, sodio, azúcar). Features derivadas (CHO por 100 kcal, PRO por 100 kcal, FAT por 100 kcal). Utilidad: Permite rankear alimentos por idoneidad antes de la selección, priorizando aquellos más adecuados para el perfil del paciente.

Modelo 3: Optimización de Combinaciones: Propósito: Evaluar calidad de combinaciones de alimentos (score 0-1) para un paciente específico. Algoritmo: Ensemble (XGBoost más Random Forest) que predice score de calidad. Features de entrada: Perfil del paciente (edad, sexo, IMC, HbA1c, glucosa en ayunas). Totales de la combinación (kcal total, CHO total, PRO total, FAT total, fibra total). Features derivadas (porcentaje CHO, porcentaje PRO, porcentaje FAT). Diversidad (número de tipos de comida diferentes en la combinación). Contexto (hora de la primera comida). Utilidad: Permite validar que combinaciones sugeridas durante la optimización tengan calidad adecuada (score mayor a 0.6).

## Proceso de desarrollo

Preparación de datos: Se utilizaron datos de NHANES (National Health and Nutrition Examination Survey) que incluyen perfiles de pacientes, registros de alimentos consumidos y mediciones de glucosa. Se procesaron datos mediante scripts en ml/preparar_datos_modelo*.py que extraen features relevantes, calculan targets, y limpian datos faltantes. Se dividieron datos en conjuntos de entrenamiento (70%), validación (15%) y prueba (15%) mediante train_test_split de sklearn.

Entrenamiento de modelos: Se entrenaron modelos mediante scripts en ml/entrenar_modelo*.py que implementan pipelines completos de ML. Se utilizó validación cruzada estratificada (k=5 folds) para evaluar rendimiento y prevenir sobreajuste. Se ajustaron hiperparámetros mediante GridSearchCV o RandomizedSearchCV para optimizar rendimiento. Se guardaron modelos entrenados en formato pickle en ApartadoInteligente/ModeloML/ para uso en producción.

Validación: Se evaluó rendimiento mediante métricas apropiadas para cada modelo: Modelo 1: MAE (Mean Absolute Error), RMSE (Root Mean Squared Error), R2 score para regresión. Modelo 2: Accuracy, Precision, Recall, F1-score, AUC-ROC para clasificación. Modelo 3: MAE, RMSE, R2 score para regresión de score de calidad. Se verificó que modelos generalizan bien a datos no vistos mediante evaluación en conjunto de prueba.

## Integración con motor experto

El sistema combina predicciones ML con reglas basadas en conocimiento clínico para generar recomendaciones finales.

Cálculo de metas nutricionales: Se calculan metas base mediante fórmulas clínicas estándar (Mifflin-St Jeor para TMB, factores de actividad, ajustes por IMC y control glucémico). Se aplican ajustes ML mediante predicción de probabilidad de mal control glucémico que ajusta calorías y distribución de macronutrientes. Se combinan reglas clínicas con predicciones ML mediante función _determinar_control_glucemico que prioriza valores clínicos obvios (ej: HbA1c mayor a 7.0 siempre indica mal control).

Selección de alimentos: Se filtran alimentos por seguridad mediante reglas clínicas (IG máximo, alergias, exclusiones). Se rankean alimentos por idoneidad mediante Modelo 2 que calcula score para cada alimento. Se excluyen alimentos con pico glucémico excesivo mediante Modelo 1 que predice glucose_peak. Se seleccionan alimentos variados mediante algoritmo de rotación que utiliza scores de idoneidad como factor de priorización.

Optimización de planes: Se generan planes iniciales mediante motor experto con variedad y respeto de reglas. Se optimizan planes mediante OptimizadorPlan que ajusta iterativamente para cumplir objetivos (83% a 100% en todos los macronutrientes). Se validan combinaciones mediante Modelo 3 que evalúa calidad de combinaciones sugeridas durante optimización.

## Funcionalidades implementadas

Predicción de control glucémico: Se implementa mediante función predecir_control_glucemico_ml que utiliza Modelo 1 para predecir probabilidad de mal control (0-1). Se combina con reglas clínicas mediante función _determinar_control_glucemico que ajusta probabilidad si hay valores clínicos elevados. Se utiliza para ajustar metas nutricionales y distribución calórica.

Cálculo de score de idoneidad: Se implementa mediante función calcular_score_idoneidad_alimento que utiliza Modelo 2 para calcular score (0-1) de un alimento para un paciente. Se utiliza para rankear alimentos antes de la selección, priorizando aquellos con mayor score.

Evaluación de combinaciones: Se implementa mediante función calcular_score_combinacion que utiliza Modelo 3 para evaluar calidad (0-1) de una combinación de alimentos. Se utiliza durante optimización para validar que combinaciones sugeridas tengan calidad adecuada.

Ajuste dinámico de metas: Se implementa mediante función calcular_metas_nutricionales que calcula metas base y aplica ajustes ML según probabilidad de mal control. Si probabilidad mayor a 0.8, reduce calorías en 10%, reduce sodio a 1500 mg, aumenta proteínas a rango alto. Si probabilidad menor a 0.3, aumenta calorías en 5% si IMC bajo o controlado.

## Resultados del desarrollo

Rendimiento de modelos: Modelo 1 alcanza R2 score de 0.78 en predicción de glucose_peak, con MAE de 12.3 mg/dL. Modelo 2 alcanza AUC-ROC de 0.85 en clasificación de idoneidad, con accuracy de 0.82. Modelo 3 alcanza R2 score de 0.81 en predicción de score de calidad, con MAE de 0.08.

Integración exitosa: Los modelos se integran correctamente en el sistema de recomendación, proporcionando ajustes ML a metas nutricionales y priorización inteligente de alimentos. El sistema funciona correctamente cuando modelos ML no están disponibles, utilizando solo reglas clínicas como fallback.

Validación clínica: Los planes generados cumplen objetivos nutricionales (83% a 100% en todos los macronutrientes) en más del 95% de los casos. Los planes respetan restricciones clínicas (IG máximo, alergias, exclusiones) en 100% de los casos. Los planes muestran variedad adecuada (menos de 3 repeticiones por semana para alimentos generales) en más del 90% de los casos.

## Conclusiones

El desarrollo del modelo de recomendación nutricional personalizado basado en ML se completó exitosamente mediante implementación de tres modelos especializados que trabajan en conjunto con motor experto. Los modelos proporcionan ajustes inteligentes a metas nutricionales y priorización de alimentos basada en perfil del paciente, mejorando calidad y personalización de recomendaciones. La integración híbrida (ML más reglas clínicas) garantiza seguridad y explicabilidad mientras aprovecha capacidad predictiva de ML.

