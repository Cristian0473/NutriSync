# 1.2.4. Integrar el modelo de recomendación nutricional a una plataforma web para la interacción del usuario final

## Demostración del cumplimiento del objetivo 4

La integración del modelo de recomendación nutricional a una plataforma web se realizó mediante desarrollo de aplicación Flask con endpoints RESTful, interfaz de usuario HTML/CSS/JavaScript, y sistema de autenticación y autorización.

## Arquitectura de la plataforma web

Backend Flask: Se desarrolló aplicación Flask en main.py que implementa todas las rutas y lógica de negocio del sistema. Se utiliza Flask como framework web por su simplicidad, flexibilidad y amplia adopción en aplicaciones Python. Se implementa arquitectura MVC (Model-View-Controller) donde modelos son clases Python (MotorRecomendacion, OptimizadorPlan), vistas son templates HTML, y controladores son funciones de ruta Flask.

Base de datos PostgreSQL: Se utiliza PostgreSQL 14 como sistema gestor de base de datos por su robustez, soporte para JSON, y amplia adopción en aplicaciones web. Se implementa conexión mediante módulo Core/bd_conexion.py que gestiona pool de conexiones y proporciona funciones helper (fetch_one, fetch_all, execute). Se utilizan consultas SQL parametrizadas para prevenir inyección SQL.

Frontend HTML/CSS/JavaScript: Se desarrollan templates HTML utilizando sistema de herencia de Jinja2 con plantilla base (base.html) y plantillas hijas que extienden esta base. Se utiliza Bootstrap 5 para estilos y componentes UI responsivos. Se utiliza JavaScript vanilla para interactividad (sin frameworks adicionales para mantener simplicidad).

## Endpoints implementados

Endpoints de autenticación: /login (GET, POST): Renderiza formulario de login y procesa autenticación. Acepta DNI o email como identificador. Verifica contraseña mediante werkzeug.security.check_password_hash. Crea sesión Flask con user_id y user_email. /logout (GET): Cierra sesión del usuario y redirige a login. /activar (GET, POST): Procesa activación de cuenta de paciente mediante token. Valida token, verifica expiración, crea usuario y asigna rol paciente.

Endpoints de administración: /admin (GET): Dashboard principal para administradores y nutricionistas. Muestra grid de módulos con acceso rápido a funcionalidades. /admin/pacientes (GET): Lista de pacientes con búsqueda, paginación y acciones (ver, editar, eliminar). /admin/clinico (GET, POST): CRUD de registros clínicos. /admin/antropometria (GET, POST): CRUD de registros antropométricos. /admin/ingredientes (GET, POST): CRUD de catálogo de ingredientes. /admin/usuarios (GET, POST): CRUD de usuarios y asignación de roles.

Endpoints de recomendación: /api/recomendacion/configuracion/<paciente_id> (GET): Obtiene configuración recomendada con ajuste ML. Retorna configuración base (antes de ML) y configuración final (después de ML). Incluye probabilidad de mal control y clasificación de control glucémico. /api/recomendacion/generar (POST): Genera plan nutricional completo. Recibe JSON con paciente_id, configuración, filtros y exclusiones. Retorna plan semanal completo con alimentos, cantidades y valores nutricionales. /admin/obtener-plan (GET): Renderiza interfaz para generar planes nutricionales. Incluye formulario de configuración, filtros y vista previa del plan.

Endpoints de planes: /api/planes (POST): Guarda plan en base de datos. Recibe JSON con paciente_id, estado, plan completo, configuración e ingredientes. Retorna ID del plan guardado y URL de detalle. /planes/<plan_id> (GET): Muestra detalle de plan guardado. Renderiza template plan_detalle.html con información completa del plan.

Endpoints de API auxiliares: /api/pacientes/buscar (GET): Búsqueda de pacientes por DNI, nombre o apellido. Retorna resultados en formato compatible con Select2. /api/ingredientes/activos (GET): Lista de ingredientes activos con búsqueda por nombre y filtro por grupo. /api/paciente/<pid>/medicamentos (GET, POST): CRUD de medicamentos del paciente. /api/paciente/<pid>/alergias (GET, POST): CRUD de alergias del paciente.

## Interfaz de usuario

Panel de login: Se implementa template login.html con diseño moderno y responsivo. Incluye formulario con campos para identificador (DNI o email) y contraseña. Muestra mensajes de error descriptivos cuando autenticación falla. Incluye enlace para recuperación de contraseña (funcionalidad futura).

Dashboard de administración: Se implementa template admin_index.html con grid de módulos. Cada módulo es una tarjeta con icono, título, descripción y enlace. Incluye navegación superior con menú desplegable de usuario y opción de logout. Diseño responsivo que se adapta a diferentes tamaños de pantalla.

Gestión de pacientes: Se implementa template pacientes_list.html con tabla dinámica de pacientes. Incluye búsqueda en tiempo real mediante endpoint /api/pacientes/buscar. Incluye paginación mediante endpoint /api/pacientes/page que retorna 10 pacientes por página. Incluye modal para registro y edición de pacientes con tabs para datos personales, antropometría y clínicos.

Generación de planes: Se implementa template obtener_plan.html con interfaz completa para generación de planes. Incluye sección de configuración con inputs para fechas, calorías objetivo, distribución de macronutrientes, IG máximo y repeticiones máximas. Incluye sección de filtros con checkboxes para exclusión de grupos alimentarios y buscador para incluir/excluir ingredientes específicos. Incluye botón "Recomendación inteligente" que consulta /api/recomendacion/configuracion para obtener configuración ajustada por ML. Incluye vista previa del plan en tres formatos: Lista (vertical), Horario (tabla temporal), Tabla Semanal (grid con días y comidas). Incluye paginación de semanas para planes de múltiples semanas. Incluye botones para guardar borrador, publicar y descargar PDF.

Visualización de planes: Se implementa template plan_detalle.html con vista detallada de planes guardados. Muestra información del plan (estado, fechas, creador) en encabezado. Muestra plan día por día con alimentos por comida, cantidades y valores nutricionales. Muestra recomendaciones especiales del sistema en sección destacada. Incluye botones para editar, eliminar y exportar plan.

## Integración del modelo ML

Carga de modelos: Los modelos ML se cargan bajo demanda cuando se necesita realizar predicciones, optimizando uso de memoria. Se implementa mediante funciones _cargar_modelo_respuesta_glucemica, _cargar_modelo_seleccion_alimentos y _cargar_modelo_optimizacion_combinaciones en MotorRecomendacion. Se utilizan rutas relativas desde la raíz del proyecto (ApartadoInteligente/ModeloML/) para garantizar portabilidad.

Uso en endpoints: El endpoint /api/recomendacion/configuracion utiliza modelos ML para calcular probabilidad de mal control y ajustar configuración. El endpoint /api/recomendacion/generar utiliza modelos ML durante generación del plan para excluir alimentos con pico glucémico excesivo y rankear alimentos por idoneidad. El optimizador utiliza Modelo 3 para validar calidad de combinaciones durante optimización.

Manejo de errores: Si modelos ML no están disponibles, el sistema continúa funcionando con reglas basadas en conocimiento, registrando advertencias en logs. Se implementa verificación de disponibilidad mediante flags _modelo_respuesta_glucemica, _modelo_seleccion_alimentos, _modelo_optimizacion_combinaciones que se inicializan en None.

## Seguridad y autorización

Autenticación: Se implementa mediante sesiones Flask con cookies firmadas. Las contraseñas se hashean mediante werkzeug.security.generate_password_hash que utiliza PBKDF2 con SHA-256. Se verifica contraseña mediante werkzeug.security.check_password_hash que compara hash de forma segura.

Autorización: Se implementa mediante decoradores Python que verifican sesión y roles antes de ejecutar vistas. @login_required verifica que haya sesión activa. @admin_required verifica que usuario tenga rol administrador. @paciente_required verifica que usuario tenga rol paciente. Se obtienen roles mediante función get_user_roles que consulta tabla usuario_rol.

Validación de entrada: Se implementa validación de entrada en todos los endpoints que reciben datos del usuario. Se verifica tipo de datos, rangos válidos y formatos correctos. Se retornan mensajes de error descriptivos cuando validación falla. Se utilizan consultas SQL parametrizadas para prevenir inyección SQL.

## Experiencia de usuario

Interfaz intuitiva: Se utiliza Bootstrap 5 para componentes UI consistentes y familiares. Se implementa navegación clara con menús y breadcrumbs. Se utilizan iconos Font Awesome para mejorar comprensión visual. Se implementan mensajes de feedback (éxito, error, advertencia) mediante Flask flash messages.

Responsividad: Se implementa diseño responsivo que se adapta a diferentes tamaños de pantalla (desktop, tablet, móvil). Se utiliza CSS Grid y Flexbox para layouts flexibles. Se implementan media queries para ajustar estilos según tamaño de pantalla.

Interactividad: Se implementa JavaScript para mejorar interactividad sin recargar página. Se utiliza AJAX para búsquedas en tiempo real y generación de planes. Se implementan animaciones suaves para transiciones y feedback visual. Se utiliza debounce en búsquedas para reducir carga del servidor.

## Resultados de la integración

Funcionalidad completa: Todos los endpoints están implementados y funcionando correctamente. La interfaz de usuario permite realizar todas las operaciones necesarias (registro, búsqueda, generación de planes, visualización). El modelo ML se integra correctamente en el flujo de generación de planes.

Rendimiento: Los tiempos de respuesta son aceptables (menos de 2 segundos para generación de planes de 7 días). La carga de modelos ML no afecta significativamente el tiempo de inicio de la aplicación (carga bajo demanda). La búsqueda de pacientes es rápida (menos de 500ms) gracias a índices en base de datos.

Usabilidad: La interfaz es intuitiva y fácil de usar según pruebas con usuarios. Los mensajes de error son descriptivos y ayudan al usuario a corregir problemas. La visualización de planes es clara y permite entender fácilmente la información nutricional.

## Conclusiones

La integración del modelo de recomendación nutricional a una plataforma web se completó exitosamente mediante desarrollo de aplicación Flask completa con endpoints RESTful, interfaz de usuario HTML/CSS/JavaScript, y sistema de autenticación y autorización. La plataforma permite a nutricionistas generar planes nutricionales personalizados de forma eficiente, aprovechando capacidades del modelo ML mientras mantiene interfaz intuitiva y segura.

