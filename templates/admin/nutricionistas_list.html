{% extends "admin/base_admin.html" %}
{% set page_title = "NutriSync ¬∑ Nutricionistas" %}
{% set header_title = "Nutricionistas" %}
{% set active_nav = "nutricionistas" %}

{% block content %}
<div class="toolbar" style="justify-content: space-between; gap:10px;">
    <button id="btnNuevoNutri" class="btn btn-primary">
        <i class="fas fa-plus"></i> Nuevo nutricionista
    </button>
    
    <!-- üîé Buscador por nombres -->
    <div class="searchbox" style="min-width:360px;">
        <i class="fas fa-user-nurse"></i>
        <input id="buscarNutricionistaInput" type="text" placeholder="Buscar nutricionista por nombre...">
        <button id="btnClearNutricionista" class="clear" title="Limpiar">√ó</button>
    </div>
</div>

<div class="content-card">
    <div class="card-header">
        <h3><i class="fas fa-user-nurse"></i> Lista de nutricionistas</h3>
    </div>
    <div class="card-body">
        <div class="table-responsive">
            <table class="tbl">
                <thead>
                    <tr>
                        <th>Email (usuario)</th>
                        <th>Nombres</th>
                        <th>Apellidos</th>
                        <th>Sexo</th>
                        <th>Colegiatura</th>
                        <th>Especialidad</th>
                        <th>Tel√©fono</th>
                        <th>Activo</th>
                        <th style="width:200px;">Acciones</th>
                    </tr>
                </thead>
                <tbody>
                    {% for n in rows %}
                    <tr>
                        <td>{{ n.email }}</td>
                        <td>{{ n.nombres or '' }}</td>
                        <td>{{ n.apellidos or '' }}</td>
                        <td>{{ n.sexo if n.sexo else 'sin especificar' }}</td>
                        <td>{{ n.colegiatura or '' }}</td>
                        <td>{{ n.especialidad or '' }}</td>
                        <td>{{ n.telefono or '' }}</td>
                        <td>
                            {% if n.perfil_activo %}
                                <span class="badge success">S√≠</span>
                            {% else %}
                                <span class="badge">No</span>
                            {% endif %}
                        </td>
                        <td class="actions">
                            <button class="btn btn-sm js-edit"
                                data-uid="{{ n.uid }}"
                                data-email="{{ n.email }}"
                                data-estado="{{ n.estado }}"
                                data-mfa="{{ '1' if n.mfa else '0' }}"
                                data-nombres="{{ n.nombres or '' }}"
                                data-apellidos="{{ n.apellidos or '' }}"
                                data-sexo="{{ n.sexo or '' }}"
                                data-colegiatura="{{ n.colegiatura or '' }}"
                                data-especialidad="{{ n.especialidad or '' }}"
                                data-telefono="{{ n.telefono or '' }}">
                                <i class="fas fa-edit"></i> Editar
                            </button>

                            <button type="button" class="btn btn-sm btn-danger js-confirmar-borrar-nutri"
                                    data-uid="{{ n.uid }}"
                                    data-email="{{ n.email }}">
                                <i class="fas fa-trash"></i> Borrar
                            </button>
                        </td>
                    </tr>
                    {% else %}
                    <tr>
                        <td colspan="9" class="empty">No hay nutricionistas registrados.</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- ===== MODAL CONFIRMACI√ìN ELIMINAR ===== -->
<div class="modal" id="modalConfirmarBorrarNutri" aria-hidden="true">
  <div class="modal-backdrop js-close-modal" data-target="#modalConfirmarBorrarNutri"></div>
  <div class="modal-dialog">
    <div class="modal-header">
      <h3><i class="fas fa-exclamation-triangle"></i> Confirmar eliminaci√≥n</h3>
      <button class="modal-close js-close-modal" data-target="#modalConfirmarBorrarNutri" aria-label="Cerrar">√ó</button>
    </div>
    <div class="modal-body">
      <p>¬øEst√° seguro de eliminar al nutricionista <strong id="emailNutricionistaBorrar"></strong>?</p>
      <p class="muted" style="margin-top: 10px; color: #6b7280;">Esto eliminar√° su usuario y perfil permanentemente.</p>
    </div>
    <div class="modal-footer">
      <button type="button" class="btn js-close-modal" data-target="#modalConfirmarBorrarNutri">Cancelar</button>
      <form id="formConfirmarBorrarNutri" method="post" style="display:inline-block">
        <button type="submit" class="btn btn-danger">
          <i class="fas fa-trash"></i> S√≠, eliminar
        </button>
      </form>
    </div>
  </div>
</div>

<!-- ===== MODAL ===== -->
<div class="modal" id="modalNutri" aria-hidden="true">
    <div class="modal-backdrop js-close-modal" data-target="#modalNutri"></div>

    <div class="modal-dialog modal-md">
        <div class="modal-header">
            <h3><i class="fas fa-user-md"></i> <span id="nutri_titulo">Nuevo nutricionista</span></h3>
            <button class="modal-close js-close-modal" data-target="#modalNutri" aria-label="Cerrar">√ó</button>
        </div>

        <form id="formNutri" method="post" action="{{ url_for('admin_nutri_nuevo') }}">
            <div class="modal-body">
                <div class="form-grid two-cols">
                    <!-- Izquierda -->
                    <div class="form-col">
                        <div class="form-row">
                            <label>Email <span style="color: #ef4444;">*</span></label>
                            <input class="input" type="email" id="n_email" name="email" required>
                            <div id="errorEmail" style="color: #ef4444; font-size: 13px; margin-top: 5px; padding-left: 2px; display: none; font-weight: 500;"></div>
                        </div>

                        <div class="form-row">
                            <label>Contrase√±a <span style="color: #ef4444;">*</span></label>
                            <div style="position: relative;">
                                <input class="input" type="text" id="n_pwd" name="password" required autocomplete="new-password" data-form-type="other" style="-webkit-text-security: disc; -moz-text-security: disc; text-security: disc; padding-right: 45px; width: 100%; box-sizing: border-box;">
                            </div>
                            <div id="errorPassword" style="color: #ef4444; font-size: 13px; margin-top: 5px; padding-left: 2px; display: none; font-weight: 500;"></div>
                        </div>

                        <div class="form-row">
                            <label>Confirmar Contrase√±a <span style="color: #ef4444;">*</span></label>
                            <div style="position: relative;">
                                <input class="input" type="text" id="n_pwd_confirm" name="password_confirm" required autocomplete="new-password" data-form-type="other" style="-webkit-text-security: disc; -moz-text-security: disc; text-security: disc; padding-right: 45px; width: 100%; box-sizing: border-box;">
                            </div>
                            <div id="errorPasswordConfirm" style="color: #ef4444; font-size: 13px; margin-top: 5px; padding-left: 2px; display: none; font-weight: 500;"></div>
                        </div>

                        <div class="form-row">
                            <label>Estado</label>
                            <select class="input" id="n_estado" name="estado">
                                <option value="activo">activo</option>
                                <option value="bloqueado">bloqueado</option>
                            </select>
                        </div>
                    </div>

                    <!-- Derecha -->
                    <div class="form-col">
                        <div class="form-row">
                            <label>Nombres <span style="color: #ef4444;">*</span></label>
                            <input class="input" type="text" id="n_nombres" name="nombres" maxlength="80" required>
                            <div id="errorNombres" style="color: #ef4444; font-size: 13px; margin-top: 5px; padding-left: 2px; display: none; font-weight: 500;"></div>
                        </div>

                        <div class="form-row">
                            <label>Apellidos <span style="color: #ef4444;">*</span></label>
                            <input class="input" type="text" id="n_apellidos" name="apellidos" maxlength="80" required>
                            <div id="errorApellidos" style="color: #ef4444; font-size: 13px; margin-top: 5px; padding-left: 2px; display: none; font-weight: 500;"></div>
                        </div>

                        <div class="form-row">
                            <label>Sexo</label>
                            <select class="input" id="n_sexo" name="sexo">
                                <option value="">(sin especificar)</option>
                                <option value="M">Masculino</option>
                                <option value="F">Femenino</option>
                                <option value="O">Otro</option>
                            </select>
                        </div>

                        <div class="form-row">
                            <label>Colegiatura <span style="color: #ef4444;">*</span></label>
                            <input class="input" type="text" id="n_colegiatura" name="colegiatura" maxlength="40" required>
                            <div id="errorColegiatura" style="color: #ef4444; font-size: 13px; margin-top: 5px; padding-left: 2px; display: none; font-weight: 500;"></div>
                        </div>

                        <div class="form-row">
                            <label>Especialidad</label>
                            <input class="input" type="text" id="n_especialidad" name="especialidad" maxlength="80">
                            <div id="errorEspecialidad" style="color: #ef4444; font-size: 13px; margin-top: 5px; padding-left: 2px; display: none; font-weight: 500;"></div>
                        </div>

                        <div class="form-row">
                            <label>Tel√©fono</label>
                            <input class="input" type="text" id="n_telefono" name="telefono" maxlength="9">
                            <div id="errorTelefono" style="color: #ef4444; font-size: 13px; margin-top: 5px; padding-left: 2px; display: none; font-weight: 500;"></div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="modal-footer">
                <button type="button" class="btn js-close-modal" data-target="#modalNutri">Cancelar</button>
                <button type="submit" class="btn btn-primary">Guardar</button>
            </div>
        </form>
    </div>
</div>

<!-- Dependencies -->
<link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet">
<script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>

<!-- Dependencies -->
<script src="https://cdn.jsdelivr.net/npm/toastify-js@1.12.0/src/toastify.min.js"></script>
<link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/toastify-js@1.12.0/src/toastify.min.css">

<style>
  /* ===== ESTILOS MODERNOS PARA NUTRICIONISTAS ===== */
  
  /* Tabla compacta y moderna */
  .tbl {
    width: 100%;
    border-collapse: collapse;
    background: white;
    border-radius: 12px;
    overflow: hidden;
    box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
    font-size: 14px;
  }
  
  .tbl th {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    padding: 16px 12px;
    text-align: left;
    font-weight: 600;
    font-size: 13px;
    text-transform: uppercase;
    letter-spacing: 0.5px;
  }
  
  .tbl td {
    padding: 14px 12px;
    border-bottom: 1px solid #f1f5f9;
    vertical-align: middle;
  }
  
  .tbl tbody tr:hover {
    background: linear-gradient(90deg, #f8fafc 0%, #e2e8f0 100%);
    transform: translateY(-1px);
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
  }
  
  /* Badges modernos */
  .badge {
    display: inline-block;
    padding: 6px 12px;
    border-radius: 20px;
    font-size: 11px;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.5px;
  }
  
  .badge.success {
    background: linear-gradient(135deg, #10b981, #059669);
    color: white;
    box-shadow: 0 2px 4px rgba(16, 185, 129, 0.3);
  }
  
  .badge:not(.success) {
    background: linear-gradient(135deg, #6b7280, #4b5563);
    color: white;
    box-shadow: 0 2px 4px rgba(107, 114, 128, 0.3);
  }
  
  /* Botones de acci√≥n modernos */
  .actions {
    display: flex;
    gap: 8px;
    align-items: center;
    flex-wrap: wrap;
  }
  
  .actions .btn {
    padding: 8px 12px;
    border-radius: 8px;
    font-size: 12px;
    font-weight: 500;
    border: none;
    cursor: pointer;
    transition: all 0.2s ease;
    display: flex;
    align-items: center;
    gap: 6px;
  }
  
  .actions .btn-sm {
    padding: 6px 10px;
    font-size: 11px;
  }
  
  .actions .btn-primary {
    background: linear-gradient(135deg, #3b82f6, #2563eb);
    color: white;
    box-shadow: 0 2px 4px rgba(59, 130, 246, 0.3);
  }
  
  .actions .btn-primary:hover {
    transform: translateY(-1px);
    box-shadow: 0 4px 8px rgba(59, 130, 246, 0.4);
  }
  
  .actions .btn-danger {
    background: linear-gradient(135deg, #ef4444, #dc2626);
    color: white;
    box-shadow: 0 2px 4px rgba(239, 68, 68, 0.3);
  }
  
  .actions .btn-danger:hover {
    transform: translateY(-1px);
    box-shadow: 0 4px 8px rgba(239, 68, 68, 0.4);
  }
  
  /* Modal mejorado */
  .modal-dialog {
    background: white;
    border-radius: 16px;
    box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
    border: 1px solid #e2e8f0;
  }
  
  .modal-dialog.modal-md {
    max-width: 600px;
  }
  
  .modal-header {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    padding: 20px 24px;
    border-radius: 16px 16px 0 0;
  }
  
  .modal-header h3 {
    margin: 0;
    font-size: 18px;
    font-weight: 600;
  }
  
  .modal-body {
    padding: 24px;
  }
  
  /* Formulario mejorado */
  .form-grid {
    display: grid;
    gap: 20px;
  }
  
  .form-grid.two-cols {
    grid-template-columns: 1fr 1fr;
  }
  
  .form-row {
    margin-bottom: 20px;
  }
  
  .form-row label {
    display: block;
    margin-bottom: 8px;
    font-weight: 500;
    color: #374151;
  }
  
  .form-row input,
  .form-row select {
    width: 100%;
    padding: 12px 16px;
    border: 2px solid #e5e7eb;
    border-radius: 8px;
    font-size: 14px;
    transition: border-color 0.2s ease;
    box-sizing: border-box;
  }
  
  .form-row select {
    min-height: 48px;
    appearance: none;
    background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='currentColor' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3e%3cpolyline points='6,9 12,15 18,9'%3e%3c/polyline%3e%3c/svg%3e");
    background-repeat: no-repeat;
    background-position: right 12px center;
    background-size: 16px;
    padding-right: 40px;
  }
  
  .form-row input:focus,
  .form-row select:focus {
    outline: none;
    border-color: #3b82f6;
    box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
  }
  
  .form-row.inline {
    display: flex;
    align-items: center;
    gap: 12px;
  }
  
  .form-row.inline label.checkbox {
    display: flex;
    align-items: center;
    gap: 8px;
    margin-bottom: 0;
    cursor: pointer;
  }
  
  .form-row.inline input[type="checkbox"] {
    width: auto;
    margin: 0;
  }
  
  .modal-footer {
    padding: 20px 24px;
    border-top: 1px solid #e5e7eb;
    display: flex;
    gap: 12px;
    justify-content: flex-end;
  }
  
  .modal-footer .btn {
    padding: 12px 24px;
    border-radius: 8px;
    font-weight: 500;
    border: none;
    cursor: pointer;
    transition: all 0.2s ease;
  }
  
  .modal-footer .btn-primary {
    background: linear-gradient(135deg, #3b82f6, #2563eb);
    color: white;
  }
  
  .modal-footer .btn-primary:hover {
    transform: translateY(-1px);
    box-shadow: 0 4px 8px rgba(59, 130, 246, 0.3);
  }
  
  /* Responsive */
  @media (max-width: 768px) {
    .tbl {
      font-size: 12px;
    }
    
    .tbl th, .tbl td {
      padding: 8px 6px;
    }
    
    .actions {
      flex-direction: column;
      gap: 4px;
    }
    
    .actions .btn {
      width: 100%;
      justify-content: center;
    }
    
    .modal-dialog {
      margin: 20px;
      width: calc(100% - 40px);
    }
    
    .form-grid.two-cols {
      grid-template-columns: 1fr;
    }
  }
</style>

<script>
// ====== BUSCADOR MEJORADO ======
$(document).ready(function () {
    // Configurar el input de b√∫squeda
    const buscarInput = document.getElementById('buscarNutricionistaInput');
    const btnClear = document.getElementById('btnClearNutricionista');
    
    let searchTimeout;
    
    buscarInput.addEventListener('input', function() {
        clearTimeout(searchTimeout);
        const query = this.value.trim();
        
        if (query.length >= 2) {
            searchTimeout = setTimeout(() => {
                // Filtrar la tabla existente
                filtrarTablaNutricionistas(query);
            }, 300);
        } else if (query.length === 0) {
            // Mostrar todos los nutricionistas
            mostrarTodosNutricionistas();
        }
        
        btnClear.style.visibility = query ? 'visible' : 'hidden';
    });
    
    btnClear.addEventListener('click', function() {
        buscarInput.value = '';
        mostrarTodosNutricionistas();
        btnClear.style.visibility = 'hidden';
        buscarInput.focus();
    });
    
    btnClear.style.visibility = 'hidden';
});

// Funci√≥n para filtrar la tabla de nutricionistas
function filtrarTablaNutricionistas(query) {
    const filas = document.querySelectorAll('tbody tr');
    let encontrados = 0;
    
    filas.forEach(fila => {
        const texto = fila.textContent.toLowerCase();
        if (texto.includes(query.toLowerCase())) {
            fila.style.display = '';
            encontrados++;
        } else {
            fila.style.display = 'none';
        }
    });
    
    // Mostrar mensaje si no hay resultados
    const tbody = document.querySelector('tbody');
    let mensajeNoEncontrado = tbody.querySelector('.no-encontrado');
    
    if (encontrados === 0) {
        if (!mensajeNoEncontrado) {
            mensajeNoEncontrado = document.createElement('tr');
            mensajeNoEncontrado.className = 'no-encontrado';
            mensajeNoEncontrado.innerHTML = '<td colspan="9" class="empty">No se encontraron nutricionistas que coincidan con la b√∫squeda.</td>';
            tbody.appendChild(mensajeNoEncontrado);
        }
        mensajeNoEncontrado.style.display = '';
    } else {
        if (mensajeNoEncontrado) {
            mensajeNoEncontrado.style.display = 'none';
        }
    }
}

// Funci√≥n para mostrar todos los nutricionistas
function mostrarTodosNutricionistas() {
    const filas = document.querySelectorAll('tbody tr');
    filas.forEach(fila => {
        fila.style.display = '';
    });
    
    const mensajeNoEncontrado = document.querySelector('.no-encontrado');
    if (mensajeNoEncontrado) {
        mensajeNoEncontrado.style.display = 'none';
    }
}

const openModal = sel => document.querySelector(sel).classList.add('open');
const closeModal = sel => document.querySelector(sel).classList.remove('open');
document.querySelectorAll('.js-close-modal').forEach(b =>
    b.addEventListener('click', () => closeModal(b.dataset.target))
);

// Nuevo
document.getElementById('btnNuevoNutri')?.addEventListener('click', () => {
    const f = document.getElementById('formNutri');
    f.action = "{{ url_for('admin_nutri_nuevo') }}";
    document.getElementById('nutri_titulo').innerText = "Nuevo nutricionista";
    ['n_email','n_pwd','n_pwd_confirm','n_nombres','n_apellidos','n_sexo','n_colegiatura','n_especialidad','n_telefono']
      .forEach(id => { const el = document.getElementById(id); if (el) el.value = ""; });
    document.getElementById('n_estado').value = "activo";
    
    // Limpiar errores
    ['errorPassword', 'errorPasswordConfirm', 'errorNombres', 'errorApellidos', 'errorColegiatura', 'errorTelefono', 'errorEmail'].forEach(id => {
        const el = document.getElementById(id);
        if (el) { el.style.display = 'none'; el.textContent = ''; }
    });
    
    // Inicializar botones de contrase√±a
    setTimeout(() => {
        initTogglePasswordNutri();
    }, 100);
    
    openModal('#modalNutri');
});

// Editar
document.querySelectorAll('.js-edit').forEach(btn => {
    btn.addEventListener('click', () => {
        const uid = btn.dataset.uid;
        const f = document.getElementById('formNutri');
        f.action = "{{ url_for('admin_nutri_editar', uid=0) }}".replace('/0', '/' + uid);

        document.getElementById('nutri_titulo').innerText = "Editar nutricionista";
        document.getElementById('n_email').value = btn.dataset.email || "";
        document.getElementById('n_pwd').value = "";
        document.getElementById('n_pwd_confirm').value = "";
        document.getElementById('n_pwd').required = false;
        document.getElementById('n_pwd_confirm').required = false;
        document.getElementById('n_estado').value = btn.dataset.estado || "activo";

        document.getElementById('n_nombres').value = btn.dataset.nombres || "";
        document.getElementById('n_apellidos').value = btn.dataset.apellidos || "";
        document.getElementById('n_sexo').value = btn.dataset.sexo || "";
        document.getElementById('n_colegiatura').value = btn.dataset.colegiatura || "";
        document.getElementById('n_especialidad').value = btn.dataset.especialidad || "";
        document.getElementById('n_telefono').value = btn.dataset.telefono || "";
        
        // Limpiar errores
        ['errorPassword', 'errorPasswordConfirm', 'errorNombres', 'errorApellidos', 'errorColegiatura', 'errorEspecialidad', 'errorTelefono', 'errorEmail'].forEach(id => {
            const el = document.getElementById(id);
            if (el) { el.style.display = 'none'; el.textContent = ''; }
        });
        
        // Inicializar botones de contrase√±a
        setTimeout(() => {
            initTogglePasswordNutri();
        }, 100);
        
        openModal('#modalNutri');
    });
});

// ====== Funciones para mostrar/ocultar contrase√±a ======
function createToggleButtonNutri(inputId, buttonId) {
    const input = document.getElementById(inputId);
    if (!input) return null;
    
    const container = input.parentElement;
    if (!container) return null;
    
    // Eliminar cualquier bot√≥n existente primero
    const existingButton = container.querySelector('.toggle-password-btn');
    if (existingButton) {
        existingButton.remove();
    }
    
    // Crear nuevo bot√≥n
    const button = document.createElement('button');
    button.type = 'button';
    button.className = 'toggle-password-btn';
    button.id = buttonId;
    button.setAttribute('aria-label', 'Mostrar u ocultar contrase√±a');
    button.style.cssText = 'position: absolute; right: 12px; top: 50%; transform: translateY(-50%); background: none; border: none; cursor: pointer; color: #6b7280; padding: 4px; font-size: 16px;';
    button.innerHTML = '<i class="fas fa-eye"></i>';
    
    // Agregar el evento
    button.addEventListener('click', function(e) {
        e.preventDefault();
        e.stopPropagation();
        const isHidden = input.style.webkitTextSecurity === 'disc' || 
                        input.style.textSecurity === 'disc' ||
                        (!input.style.webkitTextSecurity && !input.style.textSecurity);
        
        if (isHidden) {
            // Mostrar contrase√±a
            input.style.webkitTextSecurity = 'none';
            input.style.mozTextSecurity = 'none';
            input.style.textSecurity = 'none';
            const icon = button.querySelector('i');
            if (icon) {
                icon.className = 'fas fa-eye-slash';
            }
        } else {
            // Ocultar contrase√±a
            input.style.webkitTextSecurity = 'disc';
            input.style.mozTextSecurity = 'disc';
            input.style.textSecurity = 'disc';
            const icon = button.querySelector('i');
            if (icon) {
                icon.className = 'fas fa-eye';
            }
        }
    });
    
    container.appendChild(button);
    return button;
}

function initTogglePasswordNutri() {
    // Crear bot√≥n para contrase√±a principal
    createToggleButtonNutri('n_pwd', 'togglePasswordNutri');
    
    // Crear bot√≥n para confirmar contrase√±a
    createToggleButtonNutri('n_pwd_confirm', 'togglePasswordConfirmNutri');
}

// ====== Validaciones de campos ======
function validarCampoTexto(inputId, errorId, campoNombre, soloLetras = true, obligatorio = true) {
    const input = document.getElementById(inputId);
    const error = document.getElementById(errorId);
    
    if (!input || !error) return true;
    
    const valor = input.value.trim();
    
    if (obligatorio && !valor) {
        error.textContent = `${campoNombre} es obligatorio.`;
        error.style.display = 'block';
        return false;
    }
    
    if (valor && soloLetras) {
        // Solo letras y espacios
        if (!/^[a-zA-Z√°√©√≠√≥√∫√Å√â√ç√ì√ö√±√ë√º√ú\s]+$/.test(valor)) {
            error.textContent = `${campoNombre} solo puede contener letras.`;
            error.style.display = 'block';
            return false;
        }
    }
    
    error.style.display = 'none';
    error.textContent = '';
    return true;
}

function validarColegiatura(inputId, errorId) {
    const input = document.getElementById(inputId);
    const error = document.getElementById(errorId);
    
    if (!input || !error) return true;
    
    let valor = input.value.trim().toUpperCase();
    
    if (!valor) {
        error.textContent = 'Colegiatura es obligatorio.';
        error.style.display = 'block';
        return false;
    }
    
    // Formato: 3 letras, gui√≥n, 3 n√∫meros (ABC-123)
    if (!/^[A-Z]{3}-\d{3}$/.test(valor)) {
        error.textContent = 'La colegiatura debe tener el formato: 3 letras, gui√≥n, 3 n√∫meros (ej: ABC-123)';
        error.style.display = 'block';
        return false;
    }
    
    // Actualizar el valor con may√∫sculas
    input.value = valor;
    
    error.style.display = 'none';
    error.textContent = '';
    return true;
}

function validarTelefono(inputId, errorId) {
    const input = document.getElementById(inputId);
    const error = document.getElementById(errorId);
    
    if (!input || !error) return true;
    
    let valor = input.value.trim();
    
    // Si est√° vac√≠o, es opcional
    if (!valor) {
        error.style.display = 'none';
        error.textContent = '';
        return true;
    }
    
    // Eliminar caracteres no num√©ricos
    const soloNumeros = valor.replace(/\D/g, '');
    
    // Solo 9 d√≠gitos
    if (soloNumeros.length !== 9) {
        error.textContent = 'El tel√©fono debe tener exactamente 9 d√≠gitos.';
        error.style.display = 'block';
        return false;
    }
    
    // Actualizar el valor con solo n√∫meros
    input.value = soloNumeros;
    
    error.style.display = 'none';
    error.textContent = '';
    return true;
}

// ====== Aplicar validaciones en tiempo real ======
document.getElementById('n_nombres')?.addEventListener('input', function() {
    // Eliminar n√∫meros y caracteres no permitidos
    this.value = this.value.replace(/[^a-zA-Z√°√©√≠√≥√∫√Å√â√ç√ì√ö√±√ë√º√ú\s]/g, '');
    validarCampoTexto('n_nombres', 'errorNombres', 'Nombres', true);
});

document.getElementById('n_apellidos')?.addEventListener('input', function() {
    // Eliminar n√∫meros y caracteres no permitidos
    this.value = this.value.replace(/[^a-zA-Z√°√©√≠√≥√∫√Å√â√ç√ì√ö√±√ë√º√ú\s]/g, '');
    validarCampoTexto('n_apellidos', 'errorApellidos', 'Apellidos', true);
});

document.getElementById('n_colegiatura')?.addEventListener('input', function() {
    let valor = this.value.toUpperCase();
    
    // Permitir solo letras, n√∫meros y gui√≥n
    valor = valor.replace(/[^A-Z0-9\-]/g, '');
    
    // Limitar formato: m√°ximo 3 letras, gui√≥n, m√°ximo 3 n√∫meros
    if (valor.length > 0) {
        const partes = valor.split('-');
        if (partes.length > 2) {
            // Si hay m√°s de un gui√≥n, mantener solo el primero
            valor = partes[0] + '-' + partes.slice(1).join('');
        }
        
        // Limitar letras a 3
        if (partes[0] && partes[0].length > 3) {
            partes[0] = partes[0].substring(0, 3);
        }
        
        // Limitar n√∫meros a 3 despu√©s del gui√≥n
        if (partes.length > 1 && partes[1]) {
            partes[1] = partes[1].replace(/\D/g, '').substring(0, 3);
        }
        
        if (partes.length > 1 && partes[1]) {
            valor = partes[0] + '-' + partes[1];
        } else if (partes[0] && !valor.includes('-')) {
            valor = partes[0];
        }
    }
    
    this.value = valor;
    validarColegiatura('n_colegiatura', 'errorColegiatura');
});

document.getElementById('n_especialidad')?.addEventListener('input', function() {
    // Eliminar n√∫meros y caracteres no permitidos
    this.value = this.value.replace(/[^a-zA-Z√°√©√≠√≥√∫√Å√â√ç√ì√ö√±√ë√º√ú\s]/g, '');
    const errorEspecialidad = document.getElementById('errorEspecialidad');
    if (errorEspecialidad && errorEspecialidad.style.display !== 'none') {
        errorEspecialidad.style.display = 'none';
        errorEspecialidad.textContent = '';
    }
});

document.getElementById('n_telefono')?.addEventListener('input', function() {
    // Eliminar todo lo que no sea n√∫mero
    let valor = this.value.replace(/\D/g, '');
    
    // Limitar a 9 d√≠gitos
    if (valor.length > 9) {
        valor = valor.substring(0, 9);
    }
    
    this.value = valor;
    validarTelefono('n_telefono', 'errorTelefono');
});

document.getElementById('n_pwd')?.addEventListener('input', function() {
    const errorPassword = document.getElementById('errorPassword');
    if (errorPassword && errorPassword.style.display !== 'none') {
        errorPassword.style.display = 'none';
        errorPassword.textContent = '';
    }
});

document.getElementById('n_pwd_confirm')?.addEventListener('input', function() {
    const errorPasswordConfirm = document.getElementById('errorPasswordConfirm');
    if (errorPasswordConfirm && errorPasswordConfirm.style.display !== 'none') {
        errorPasswordConfirm.style.display = 'none';
        errorPasswordConfirm.textContent = '';
    }
    
    // Validar en tiempo real si coinciden
    const password = document.getElementById('n_pwd');
    if (password && this.value && password.value !== this.value) {
        if (errorPasswordConfirm) {
            errorPasswordConfirm.textContent = 'Las contrase√±as no coinciden';
            errorPasswordConfirm.style.display = 'block';
        }
    } else if (password && this.value && password.value === this.value) {
        if (errorPasswordConfirm) {
            errorPasswordConfirm.style.display = 'none';
            errorPasswordConfirm.textContent = '';
        }
    }
});

// ====== Manejar env√≠o del formulario ======
document.getElementById('formNutri')?.addEventListener('submit', function(e) {
    e.preventDefault();
    e.stopPropagation();
    
    const form = this;
    const isNuevo = form.action.includes('/nuevo');
    
    // Limpiar errores
    ['errorPassword', 'errorPasswordConfirm', 'errorNombres', 'errorApellidos', 'errorColegiatura', 'errorTelefono', 'errorEmail'].forEach(id => {
        const el = document.getElementById(id);
        if (el) { el.style.display = 'none'; el.textContent = ''; }
    });
    
    // Validar campos
    let esValido = true;
    
    // Validar nombres
    if (!validarCampoTexto('n_nombres', 'errorNombres', 'Nombres', true)) {
        esValido = false;
    }
    
    // Validar apellidos
    if (!validarCampoTexto('n_apellidos', 'errorApellidos', 'Apellidos', true)) {
        esValido = false;
    }
    
    // Validar colegiatura
    if (!validarColegiatura('n_colegiatura', 'errorColegiatura')) {
        esValido = false;
    }
    
    // Validar especialidad (opcional pero solo letras)
    if (!validarCampoTexto('n_especialidad', 'errorEspecialidad', 'Especialidad', true, false)) {
        esValido = false;
    }
    
    // Validar tel√©fono
    if (!validarTelefono('n_telefono', 'errorTelefono')) {
        esValido = false;
    }
    
    // Validar contrase√±as (solo si es nuevo o si se proporciona contrase√±a)
    const password = document.getElementById('n_pwd').value;
    const passwordConfirm = document.getElementById('n_pwd_confirm').value;
    
    if (isNuevo) {
        if (!password) {
            const errorPassword = document.getElementById('errorPassword');
            if (errorPassword) {
                errorPassword.textContent = 'La contrase√±a es obligatoria';
                errorPassword.style.display = 'block';
            }
            esValido = false;
        } else if (password.length < 6) {
            const errorPassword = document.getElementById('errorPassword');
            if (errorPassword) {
                errorPassword.textContent = 'La contrase√±a debe tener al menos 6 caracteres';
                errorPassword.style.display = 'block';
            }
            esValido = false;
        }
        
        if (!passwordConfirm) {
            const errorPasswordConfirm = document.getElementById('errorPasswordConfirm');
            if (errorPasswordConfirm) {
                errorPasswordConfirm.textContent = 'Debe confirmar la contrase√±a';
                errorPasswordConfirm.style.display = 'block';
            }
            esValido = false;
        } else if (password !== passwordConfirm) {
            const errorPasswordConfirm = document.getElementById('errorPasswordConfirm');
            if (errorPasswordConfirm) {
                errorPasswordConfirm.textContent = 'Las contrase√±as no coinciden';
                errorPasswordConfirm.style.display = 'block';
            }
            esValido = false;
        }
    } else if (password) {
        // Si se est√° editando y se proporciona contrase√±a, validar
        if (!passwordConfirm) {
            const errorPasswordConfirm = document.getElementById('errorPasswordConfirm');
            if (errorPasswordConfirm) {
                errorPasswordConfirm.textContent = 'Debe confirmar la contrase√±a';
                errorPasswordConfirm.style.display = 'block';
            }
            esValido = false;
        } else if (password !== passwordConfirm) {
            const errorPasswordConfirm = document.getElementById('errorPasswordConfirm');
            if (errorPasswordConfirm) {
                errorPasswordConfirm.textContent = 'Las contrase√±as no coinciden';
                errorPasswordConfirm.style.display = 'block';
            }
            esValido = false;
        } else if (password.length < 6) {
            const errorPassword = document.getElementById('errorPassword');
            if (errorPassword) {
                errorPassword.textContent = 'La contrase√±a debe tener al menos 6 caracteres';
                errorPassword.style.display = 'block';
            }
            esValido = false;
        }
    }
    
    if (!esValido) {
        return;
    }
    
    // Si todo es v√°lido, enviar el formulario con AJAX
    const formData = new FormData(form);
    
    fetch(form.action, {
        method: 'POST',
        headers: {
            'X-Requested-With': 'XMLHttpRequest',
            'Accept': 'application/json'
        },
        body: formData,
        redirect: 'manual'
    })
    .then(response => {
        const contentType = response.headers.get('content-type');
        if (contentType && contentType.includes('application/json')) {
            return response.json();
        } else {
            // Si no es JSON, puede ser un redirect o error HTML
            return response.text().then(text => {
                throw new Error('Respuesta no JSON');
            });
        }
    })
    .then(data => {
        if (data.ok) {
            // Mostrar mensaje de √©xito
            Toastify({
                text: "‚úÖ " + (data.message || "Nutricionista guardado correctamente"),
                duration: 3000,
                gravity: "top",
                position: "right",
                backgroundColor: "#10b981",
            }).showToast();
            
            // Cerrar modal y recargar
            closeModal('#modalNutri');
            setTimeout(() => {
                window.location.reload();
            }, 1000);
        } else {
            // Mostrar errores en los campos correspondientes
            if (data.errores) {
                if (data.errores.email) {
                    const errorEmail = document.getElementById('errorEmail');
                    if (errorEmail) {
                        errorEmail.textContent = data.errores.email;
                        errorEmail.style.display = 'block';
                    }
                }
                if (data.errores.telefono) {
                    const errorTelefono = document.getElementById('errorTelefono');
                    if (errorTelefono) {
                        errorTelefono.textContent = data.errores.telefono;
                        errorTelefono.style.display = 'block';
                    }
                }
                if (data.errores.nombres) {
                    const errorNombres = document.getElementById('errorNombres');
                    if (errorNombres) {
                        errorNombres.textContent = data.errores.nombres;
                        errorNombres.style.display = 'block';
                    }
                }
                if (data.errores.apellidos) {
                    const errorApellidos = document.getElementById('errorApellidos');
                    if (errorApellidos) {
                        errorApellidos.textContent = data.errores.apellidos;
                        errorApellidos.style.display = 'block';
                    }
                }
                if (data.errores.especialidad) {
                    const errorEspecialidad = document.getElementById('errorEspecialidad');
                    if (errorEspecialidad) {
                        errorEspecialidad.textContent = data.errores.especialidad;
                        errorEspecialidad.style.display = 'block';
                    }
                }
                if (data.errores.password) {
                    const errorPassword = document.getElementById('errorPassword');
                    if (errorPassword) {
                        errorPassword.textContent = data.errores.password;
                        errorPassword.style.display = 'block';
                    }
                }
                if (data.errores.password_confirm) {
                    const errorPasswordConfirm = document.getElementById('errorPasswordConfirm');
                    if (errorPasswordConfirm) {
                        errorPasswordConfirm.textContent = data.errores.password_confirm;
                        errorPasswordConfirm.style.display = 'block';
                    }
                }
                if (data.errores.general) {
                    Toastify({
                        text: "‚ùå " + data.errores.general,
                        duration: 3000,
                        gravity: "top",
                        position: "right",
                        backgroundColor: "#ef4444",
                    }).showToast();
                }
            }
        }
    })
    .catch(error => {
        console.error('Error:', error);
        // En caso de error, enviar el formulario normalmente
        form.submit();
    });
});

// Inicializar cuando el DOM est√© listo
if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', function() {
        initTogglePasswordNutri();
    });
} else {
    initTogglePasswordNutri();
}

// Borrar con modal de confirmaci√≥n
document.querySelectorAll('.js-confirmar-borrar-nutri').forEach(btn => {
    btn.addEventListener('click', () => {
        const uid = btn.dataset.uid;
        const email = btn.dataset.email;
        
        // Configurar el modal
        document.getElementById('emailNutricionistaBorrar').textContent = email;
        document.getElementById('formConfirmarBorrarNutri').action = `/admin/nutricionistas/${uid}/borrar`;
        
        // Mostrar el modal
        document.querySelector('#modalConfirmarBorrarNutri').classList.add('open');
    });
});
</script>
{% endblock %}
